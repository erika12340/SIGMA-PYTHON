{% extends "templates2/index.html" %}
{% block content %}

<div class="container">
    <h3 class="judul mb-4">TRACING BARCODE BUILDING</h3>
    <!-- FILTER -->
    <div class="container mt-4">
        <div class="card mb-4 shadow-sm">
            <div class="card-body">

                <!-- === FORM BARCODE === -->
                <form method="get" action="tracing_barcode" class="row g-3">
                    <!-- BARCODE SELECTED -->
                    <div class="col-md-6">
                        <label for="barcode" class="form-label fw-bold">Tyre Barcode :</label>
                        <select name="barcode" id="barcode" class="form-control">
                            <option value="">-- Pilih Barcode --</option>
                            {% for barcode in barcode_list %}
                            <option value="{{ barcode }}" {% if barcode == selected_barcode %}selected{% endif %}>
                                {{ barcode }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- BUTTON SUBMIT -->
                    <div class="col-md-3 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary w-100">Submit</button>
                    </div>

                    <!-- BUTTON RESET -->
                    <div class="col-md-3 d-flex align-items-end">
                        <a href="tracing_barcode" class="btn btn-success btn-reset w-100">Reset</a>
                    </div>
                </form>

                <!-- === DETAIL BARCODE === -->
                <div class="card mt-4">
                    <div class="card-body">
                        <h6 class="fw-bold mb-3">Detail Barcode</h6>
                        <form>
                            <div class="row mb-3">

                                <!-- MATERIAL -->
                                <div class="col-md-6">
                                    <label class="form-label">Material :</label>
                                    <input type="text" class="form-control"
                                        value="{{ material_detail.MAT_CODE }} - {{ material_detail.MAT_SAP_CODE }} - {{ material_detail.MAT_DESC }}"
                                        readonly>
                                </div>

                                <!-- MACHINE -->
                                <div class="col-md-6">
                                    <label class="form-label">Production Machine :</label>
                                    <input type="text" class="form-control"
                                        value="{{ material_detail.pp_code }} - {{ material_detail.mch_code }}" readonly>
                                </div>

                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- === TRACING BARCODE === -->
        {% for row in traceability %}
        <div class="material-item level-{{ row.level|add:1 }} mb-1">

            <button class="toggle-btn" data-id="{{ forloop.counter }}">▶</button>

            {% if row.baris1 %}
            {{ row.baris1.TRC_SO_CODE }} -
            ({{ row.baris1.SFC_DESC }}) -
            {{ row.baris1.TRC_MAT_SAP_CODE }} -
            {{ row.baris1.MAT_DESC }}
            {% endif %}

            <!-- Tombol Detail -->
            <button type="button" 
                class="btn btn-sm btn-info ms-2 show-detail"
                data-pp="{{ row.TRC_PP_CODE }}"
                data-ppdesc="{{ row.PP_DESC }}"
                data-mch="{{ row.TRC_MCH_CODE }}"
                data-sfc="{{ row.SFC_DESC }}"
                data-mat="{{ row.MAT_CODE }}"
                data-matsap="{{ row.MAT_SAP_CODE }}"
                data-start="{{ row.TRC_START_TIME }}"
                data-end="{{ row.TRC_END_TIME }}"
                data-wm="{{ row.WM_NAME }}">
                Detail
            </button>

            <br>

            {% if row.baris2 %}
            <div class="baris2-wrapper ms-4 mt-1">
                {% for b2 in row.baris2 %}
                <div class="baris2 mb-1">
                    {{ b2.TRC_PP_CODE }} -
                    {{ b2.TRC_MCH_CODE }} -
                    {{ b2.MT_DESC }}
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>
        {% endfor %}

    </div>
</div>

<!-- ===== MODAL DETAIL ===== -->
<div class="modal fade" id="detailModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Detail Tracing</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="modalContent"></div>
      </div>
    </div>
  </div>
</div>

<!-- JS  -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<script>
    // ======= SCRIPT MODAL DETAIL =======
    document.addEventListener("DOMContentLoaded", () => {
        document.querySelectorAll(".show-detail").forEach(btn => {
            btn.addEventListener("click", () => {

                let detail = JSON.parse(document.getElementById(btn.dataset.detail).textContent);

                let html = `
                    <b>Material:</b> ${detail.baris1.TRC_MAT_SAP_CODE} - ${detail.baris1.MAT_DESC}<br>
                    <b>SO Code:</b> ${detail.baris1.TRC_SO_CODE}<br>
                    <b>SFC:</b> ${detail.baris1.SFC_DESC}<br><br>
                `;

                if (detail.baris2 && detail.baris2.length > 0) {
                    html += `<b>Machine Detail:</b><br>`;
                    detail.baris2.forEach(b2 => {
                        html += `${b2.TRC_PP_CODE} - ${b2.TRC_MCH_CODE} - ${b2.MT_DESC}<br>`;
                    });
                }

                document.getElementById("modalContent").innerHTML = html;

                new bootstrap.Modal(document.getElementById("detailModal")).show();
            });
        });
    });
</script>

<!-- JS Toggle (samakan persis dengan menu Materials) -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll(".material-item.level-1").forEach(item => item.style.display = "block");

        document.querySelectorAll(".toggle-btn").forEach(btn => {
            btn.addEventListener("click", function () {
                let currentItem = this.closest(".material-item");
                let currentLevel = parseInt(currentItem.className.match(/level-(\d+)/)[1]);
                let next = currentItem.nextElementSibling;
                let isExpanding = this.textContent === "▶";
                this.textContent = isExpanding ? "▼" : "▶";

                while (next && next.classList.contains("material-item")) {
                    let level = parseInt(next.className.match(/level-(\d+)/)[1]);
                    if (level <= currentLevel) break;
                    if (level === currentLevel + 1) next.style.display = isExpanding ? "block" : "none";
                    if (!isExpanding && level > currentLevel) {
                        let toggle = next.querySelector(".toggle-btn");
                        if (toggle) toggle.textContent = "▶";
                        next.style.display = "none";
                    }
                    next = next.nextElementSibling;
                }
            });
        });
    });
</script>



<!-- JS SELECT2-->
<script>
    $('#barcode').select2();
    $('#reset').select2();
    $('submit').select2();
</script>
{% endblock %}





















<!--

BUATKAN VIEW.PY - BAGIAN FORM
1. form TRC_BARCODE ambil dari TRC_BASIC_TABLE
2. Form detail barcode bagian Materials: cari MAT_SAP_CODE pada TRC_BASIC_TABLE di MD_MATERIALS ambil data MAT_CODE dan MAT_DESC,
3. Form detail barcode bagian Production machine : ambil data PP_CODE dan MCH_CODE di TRC_BASIC_TABLE berdasarkan TRC_BARCODE terpilih.

BAGIAN DATA TRACING
1. MAT_SAP_CODE pada barcode terpilih di tabel TRC_BASIC_TABLE, Cari di MD_BOM sebagai MAT_SAP_CODE dan ambil SEMUA CHILD_MAT_SAP_CODE NYA
2. KEMUDIAN di WMS_TRACEABILITY CARI CHILD_MAT_SAP_CODE SEBAGAI KOLOM TRC_MAT_SAP_CODE, serta cari berdasarkan MCH_CODE DAN PP_CODE berdasarkan TRC_BARCODE yang terpilih DI TABEL TRC_BASIC_TABLE kalo di TABEL WMS_TRACEABILITY (namanya : TRC_MCH_CODE dan TRC_PP_CODE) dan ambil data TRC_SO_CODE dan TRC_CU_EXT_PROGR (semua) Tampa pengaturan apapun entah itu FL_PHASE NYA P ATAU C karna ketentuannya hanya berdasarkan TRC_MAT_SAP_CODE TRC_MCH_CODE DAN TRC_PP_CODE. 
3. tahap selanjutnya ada pengaturan khsusu Cari TRC_SO_CODE dan TRC_CU_EXT_PROGR di WMS_TRACEABILITY dan ambil yang TRC_FL_PHASE nya = 'P' Untuk tampil di baris 1 dan baris 2

BARIS 1 DAN BARIS 2
1. Baris 1 : TRC_SO_CODE, TRC_CU_EXT_PROGR, TRC_MAT_SAP_CODE (dari WMS_TRACEABILITY), MAT_DESC (JOIN DARI MD_MATERIALS), SFC_DESC (JOIN WMS_TRACEABILITY AMBIL TRC_MAT_SAP_CODE DAN JOIN DENGAN MD_MATERIALS UNTUK MENCARI SEBAGAI MAT_SAP_CODE DAN MENGAMBIL SFC_CODE LALU CARI SFC_CODE NYA DI MD_SEMI_FINISHED_CLASSES DAN AMBIL SFC_DESC NYA)
2. Baris 2 : TRC_PP_CODE, TRC_MCH_CODE (dari WMS_TRACEABILITY) Berdasarkan TRC_SO_CODE dan TRC_CU_EXT_PROGR, MT_DESC (Join MD_BOM UNTUK AMBIL DATA MT_CODE DAN JOIN KE [MD_MACHINE_TYPES] UNTUK AMBIL MT_DESC)


CHILD
1. Cari TRC_SO_CODE dan TRC_CU_EXT_PROGR root pertama di WMS_TRACEABILITY_CU sebagai SO_CODE dan CU_EXT_PROGR dan ambil [CHILD_SO_CODE] dan [CHILD_CU_EXT_PROGR]
2. Kemudia cari lagi [CHILD_SO_CODE] dan [CHILD_CU_EXT_PROGR] di [WMS_TRACEABILITY] sebagai TRC_SO_CODE dan TRC_CU_EXT_PROGR (AMBIL YANG TRC_FL_PHASE = 'P')
3. itu lah childnya yang tampil sepaket baris1 dan baris2
4. Begitu seterusnya sampai child habis tidak ada child lagi


-->
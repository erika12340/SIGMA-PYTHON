{% extends "templates2/index.html" %}
{% block content %}

<style>
/* ================= ERROR ================= */
.material-error {
    background-color: #d70000;
    color: #ffffff;
    font-weight: 600;
    border-radius: 4px;
    padding: 3px 4px;
}

.baris1-text { cursor: pointer; }
.baris2 { cursor: default; opacity: 0.85; }

/* ================= TREE BASE ================= */
.material-item {
    position: relative;
    padding-left: 1px; /* ruang garis */
}

/* ================= SCREEN ================= */
.material-item::before,
.material-item::after,
.print-separator {
    display: none !important;
}

/* ================= PRINT ONLY ================= */
@media print {

    /* === TREE LINE === */
    .material-item::before {
        content: "";
        position: absolute;
        left: 12px;
        top: 0;
        bottom: 0;
        border-left: 1px dashed #000;
        display: block;
    }

    .material-item::after {
        content: "";
        position: absolute;
        left: 12px;
        top: 18px;
        width: 16px;
        border-top: 1px dashed #000;
        display: block;
    }

    .material-item.level-1::before {
        display: none;
    }

    /* === HILANGKAN PANAH === */
    .toggle-btn {
        display: none !important;
    }

    /* === HILANGKAN SEMUA BORDER === */
    *,
    .card,
    .card-body,
    input,
    table,
    tr,
    td,
    hr {
        border: none !important;
        box-shadow: none !important;
        outline: none !important;
    }

    body {
        font-size: 11px;
    }

    .btn,
    form,
    select {
        display: none !important;
    }

    /* === GARIS PEMISAH TEXT === */
    .print-separator {
        display: inline-block;
        width: 40px;
        border-top: 1px solid #000;
        margin: 0 6px;
        vertical-align: middle;
    }
}
</style>

<div class="container">
    <h3 class="judul mb-4">TRACING BARCODE BUILDING</h3>

    <!-- FILTER -->
    <div class="card mb-4 shadow-sm">
        <div class="card-body">

            <form method="get" action="tracing_barcode" class="row g-3">
                <div class="col-md-6">
                    <label class="form-label fw-bold">Tyre Barcode :</label>
                    <select name="barcode" id="barcode" class="form-control">
                        <option value="">-- Pilih Barcode --</option>
                        {% for barcode in barcode_list %}
                        <option value="{{ barcode }}" {% if barcode == selected_barcode %}selected{% endif %}>
                            {{ barcode }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-md-3 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100">Submit</button>
                </div>

                <div class="col-md-3 d-flex align-items-end">
                    <a href="tracing_barcode" class="btn btn-success w-100">Reset</a>
                </div>
            </form>

            {% if material_detail %}
            <div class="card mt-4">
                <div class="card-body">
                    <h6 class="fw-bold mb-3">Detail Barcode</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">Material :</label>
                            <input type="text" class="form-control"
                                   value="{{ material_detail.MAT_CODE }} - {{ material_detail.MAT_SAP_CODE }} - {{ material_detail.MAT_DESC }}"
                                   readonly>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Production Machine :</label>
                            <input type="text" class="form-control"
                                   value="{{ material_detail.pp_code }} - {{ material_detail.mch_code }}"
                                   readonly>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <div class="d-flex justify-content-end m-3">
            <button onclick="cetakTraceabilityPDF()" class="btn btn-danger">
                Save PDF
            </button>
        </div>
    </div>

    <!-- TREE -->
    <div class="card">
        <div class="card-body">

            {% for row in traceability %}
            <div class="material-item level-{{ row.level|add:1 }} mb-1">

                {% if row.baris1 %}
                <div class="baris1-wrapper mt-1">
                    <button class="toggle-btn mt-1">▶</button>

                    <span class="baris1-text {% if row.baris1.is_invalid_material %}material-error{% endif %}">
                        ({{ row.baris1.TRC_SO_CODE }} - {{ row.baris1.TRC_CU_EXT_PROGR }})
                        ({{ row.baris1.SFC_DESC }})

                        <span class="print-separator"></span>

                        {{ row.baris1.TRC_MAT_SAP_CODE }} - {{ row.baris1.MAT_DESC }}
                    </span>
                </div>
                {% endif %}

                {% if row.baris2 %}
                <div class="baris2-wrapper mt-1">
                    {% for b2 in row.baris2 %}
                    <div class="baris2">
                        {{ b2.TRC_PP_CODE }} - {{ b2.TRC_MCH_CODE }} - {{ b2.MT_DESC }}
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            {% endfor %}

        </div>
    </div>
</div>

<!-- ================= TREE JS ================= -->
<script>
document.querySelectorAll(".material-item.level-1")
    .forEach(i => i.style.display = "block");

document.querySelectorAll(".toggle-btn").forEach(btn => {
    btn.addEventListener("click", function () {
        let item = this.closest(".material-item");
        let lvl = parseInt(item.className.match(/level-(\d+)/)[1]);
        let open = this.textContent === "▶";
        this.textContent = open ? "▼" : "▶";

        let next = item.nextElementSibling;
        while (next && next.classList.contains("material-item")) {
            let nl = parseInt(next.className.match(/level-(\d+)/)[1]);
            if (nl <= lvl) break;
            next.style.display = open ? "block" : "none";
            next = next.nextElementSibling;
        }
    });
});
</script>

<!-- ================= PRINT JS ================= -->
<script>
function cetakTraceabilityPDF() {
    const items = document.querySelectorAll(".material-item");
    const toggles = document.querySelectorAll(".toggle-btn");

    let prevDisplay = [];
    let prevToggle = [];

    items.forEach((el, i) => {
        prevDisplay[i] = el.style.display;
        el.style.display = "block";
    });

    toggles.forEach((btn, i) => {
        prevToggle[i] = btn.textContent;
        btn.textContent = "▼";
    });

    setTimeout(() => {
        window.print();
        items.forEach((el, i) => el.style.display = prevDisplay[i]);
        toggles.forEach((btn, i) => btn.textContent = prevToggle[i]);
    }, 300);
}
</script>

<script>
$('#barcode').select2();
</script>

{% endblock %}

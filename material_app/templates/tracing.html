{% extends "templates2/index.html" %}
{% block content %}

<!-- contant -->
<div class="container">
    <h3 class="judul mb-4">Tyre Barcode</h3>

    <!-- FILTER -->
    <div class="container mt-4">
        <div class="card mb-4 shadow-sm">
            <div class="card-body">
                <form method="get" action="traceability_by_machine" class="row g-3" id="filterForm">

                    <!-- Production Phase -->
                    <div class="col-md-4">
                        <label for="trc" class="form-label fw-bold">Tyre Barcode :</label>
                        <select name="trc_code" id="trc" class="form-select" onchange="this.form.submit()">
                            <option value="">-- Tyre Barcode --</option>
                            {% for trc in trc_list %}
                            <option value="{{ trc.TRC_BARCODE }}"
                                {% if trc.TRC_PP_CODE == selected_trc %}selected{% endif %}>
                                {{ trc.TRC_PP_CODE }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                </form>
                <div class="card mb-4">
                    <div class="card-body">
                        <form>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">Material :</label>
                                    <input type="text" class="form-control" value="{{ material_detail.mat_desc }}"
                                        readonly>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Production Machine :</label>
                                    <input type="text" class="form-control" value="{{ material_detail.ip_code }}"
                                        readonly>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Tombol Reset -->
                <div class="row mt-4">
                    <div class="col-md-12">
                        <a href="traceability_by_machine" class="btn btn-primary btn-reset">Reset</a>
                    </div>
                </div>

            </div>
        </div>

        <!-- traceability -->
        {% if traceability %}
        <div class="card">
            <div class="card-body">
                <h5 class="card-title mb-3">Data Tracing</h5>
                <div id="material-tree" class="overflow-auto border rounded p-2" style="max-height: 500px;">
                    {% for row in traceability %}
                    <div class="material-item level-{{ row.level|add:1 }} mb-1">
                        <div data-bs-spy="scroll" data-bs-target="#list-example" data-bs-offset="0"
                            class="scrollspy-example" tabindex="0">
                            <button class="toggle-btn" data-id="{{ forloop.counter }}">▶</button>
                            <!-- traceability views by machine -->
                            {% if row.type == "root" %}
                            <!-- Root node -->
                            {{ row.baris1.TRC_SO_CODE }}
                            {{ row.baris1.SFC_DESC }} -
                            {{ row.baris1.MAT_SAP_CODE }} -
                            {{ row.baris1.MAT_DESC }} -
                            <br>
                            {% if row.baris2 %}
                            <div class="baris2">
                                {{ row.baris2.TRC_PP_CODE }} -
                                {{ row.baris2.TRC_MCH_CODE }} -
                                {{ row.baris2.SFC_DESC }}
                            </div>
                            {% endif %}
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>
<!-- end contant -->

<!-- JS  -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/2.3.2/js/dataTables.js"></script>
<script src="https://cdn.datatables.net/buttons/3.2.4/js/dataTables.buttons.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
<script src="https://cdn.datatables.net/buttons/3.2.4/js/buttons.html5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>



<!-- JAVA SCRIPT TOGGLE CHILD -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        // Tampilkan semua level-1 (root)
        document.querySelectorAll(".material-item.level-1").forEach(item => item.style.display = "block");
        document.querySelectorAll(".toggle-btn").forEach(btn => {
            btn.addEventListener("click", function () {
                let currentItem = this.parentElement.parentElement;
                let currentLevel = parseInt(currentItem.className.match(/level-(\d+)/)[1]);
                let next = currentItem.nextElementSibling;
                let isExpanding = this.textContent === "▶";
                this.textContent = isExpanding ? "▼" : "▶";
                while (next && next.classList.contains("material-item")) {
                    let level = parseInt(next.className.match(/level-(\d+)/)[1]);
                    if (level <= currentLevel) break;
                    if (level === currentLevel + 1) {
                        next.style.display = isExpanding ? "block" : "none";
                    }
                    if (!isExpanding && level > currentLevel) {
                        let toggle = next.querySelector(".toggle-btn");
                        if (toggle) toggle.textContent = "▶";
                        next.style.display = "none";
                    }
                    next = next.nextElementSibling;
                }
            });
        });
    });
</script>

<!-- JS SELECT2-->
<script>
    $('#trc').select2();
    $('#mch_info').select2();
    $('#trc_fl_phase').select2();
    $('#start_date').select2();
    $('#end_date').select2();
</script>

{% endblock %}


<!-- untuk html ini buatkan untuk form barcode dimana bisa di input terus button submit, terud ada form materials dan form production machine tapi tidak diinput nanti setelah klik submit datanya muncul sendiri -->

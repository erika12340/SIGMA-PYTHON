# ==================== Traceability By Materials ============================
def traceability_by_materials(request):
allowed_sfc_code = ['C0', 'CC', 'CE', 'CP', 'CX', 'FB', 'RC', 'TB', 'TT']

sfc_code = request.GET.get('sfc_code')
mat_info = request.GET.get('mat_info')
start_date_raw = request.GET.get('start_date')
end_date_raw = request.GET.get('end_date')
trc_fl_phase = request.GET.get('trc_fl_phase')

def parse_date_shift(raw_value):
if not raw_value:
return None, None
try:
date_part, shift_part = raw_value.split('|')
date_obj = datetime.strptime(date_part, "%Y-%m-%d").date()
return date_obj, int(shift_part)
except Exception:
return None, None

start_date, start_shift = parse_date_shift(start_date_raw)
end_date, end_shift = parse_date_shift(end_date_raw)

def hour_to_shift(hour):
if 0 <= hour < 8: return 1 if 8 <=hour < 16: return 2 return 3 sfc_list=( MD_SEMI_FINISHED_CLASSES.objects
    .filter(SFC_CODE__in=allowed_sfc_code) .values('SFC_CODE', 'SFC_DESC' ) .distinct() .order_by('SFC_CODE') )
    material_list=[] if sfc_code: wms_mats=( WMS_TRACEABILITY.objects .filter(TRC_MAT_SAP_CODE__isnull=False,
    TRC_MAT_SAP_CODE__gt='' ) .values('TRC_MAT_SAP_CODE', 'TRC_CNT_CODE' , 'TRC_MAT_VARIANT' ) .distinct()
    .order_by('TRC_MAT_SAP_CODE') ) for mat in wms_mats: if MD_MATERIALS.objects.filter(
    MAT_SAP_CODE=mat['TRC_MAT_SAP_CODE'], SFC_CODE=sfc_code ).exists(): mat_detail=MD_MATERIALS.objects.filter(
    MAT_SAP_CODE=mat['TRC_MAT_SAP_CODE'] ).values('MAT_CODE', 'MAT_DESC' ).first()
    material_list.append({ 'TRC_MAT_SAP_CODE' : mat['TRC_MAT_SAP_CODE'], 'TRC_CNT_CODE' :
    mat['TRC_CNT_CODE'], 'TRC_MAT_VARIANT' : mat['TRC_MAT_VARIANT'], 'MAT_CODE' : mat_detail['MAT_CODE'] if mat_detail
    else '' , 'MAT_DESC' : mat_detail['MAT_DESC'] if mat_detail else '' , }) phase=( WMS_TRACEABILITY.objects
    .values('TRC_FL_PHASE') .distinct() .order_by('TRC_FL_PHASE') ) date_shift_choices=[] date_shift_raw_qs=(
    WMS_TRACEABILITY.objects .annotate(date=TruncDate('TRC_START_TIME')) .annotate(hour=ExtractHour('TRC_START_TIME'))
    .values('date', 'hour' ) .distinct() .order_by('-date', 'hour' ) ) seen=set() for rec in date_shift_raw_qs:
    date=rec.get('date') hour=rec.get('hour') if date is None or hour is None: continue shift=hour_to_shift(hour)
    key=(date, shift) if key in seen: continue seen.add(key) label=f"{date.strftime('%d/%m/%Y')} - Shift {shift}"
    value=f"{date.isoformat()}|{shift}" date_shift_choices.append({'value': value, 'label' : label})
    traceability_materials=[] if sfc_code and mat_info and start_date and end_date and trc_fl_phase: # Build query
    without shift filter IF phase=='P' traceability_qs=( WMS_TRACEABILITY.objects .filter(TRC_MAT_SAP_CODE=mat_info)
    .filter(TRC_START_TIME__date__range=(start_date, end_date)) .filter(TRC_FL_PHASE=trc_fl_phase)
    .order_by('TRC_START_TIME') ) # Only apply shift filter if phase !='P' AND shift is provided if trc_fl_phase !='P'
    and start_shift: shift_start=None shift_end=None if start_shift==1: shift_start=datetime.combine(start_date, time(0,
    0, 0)) shift_end=datetime.combine(start_date, time(8, 0, 0)) elif start_shift==2:
    shift_start=datetime.combine(start_date, time(8, 0, 0)) shift_end=datetime.combine(start_date, time(16, 0, 0)) elif
    start_shift==3: shift_start=datetime.combine(start_date, time(16, 0, 0)) shift_end=datetime.combine(start_date +
    timedelta(days=1), time(0, 0, 0)) if shift_start and shift_end: traceability_qs=traceability_qs.filter(
    Q(TRC_END_TIME__gte=shift_start, TRC_START_TIME__lte=shift_end) | Q(TRC_START_TIME__range=(shift_start, shift_end))
    | Q(TRC_END_TIME__range=(shift_start, shift_end)) ) traceability_qs=traceability_qs.annotate( MAT_CODE=Subquery(
    MD_MATERIALS.objects.filter(MAT_SAP_CODE=OuterRef('TRC_MAT_SAP_CODE')).values('MAT_CODE')[:1] ), WM_NAME=Subquery(
    MD_WORKERS.objects.filter(WM_CODE=OuterRef('TRC_WM_CODE')).values('WM_NAME')[:1] ) )
    traceability_raw=list(traceability_qs.values( 'TRC_PP_CODE' ,'TRC_MCH_CODE','TRC_SO_CODE', 'TRC_MAT_SAP_CODE'
    ,'TRC_CNT_CODE','TRC_MAT_VARIANT', 'TRC_WM_CODE' ,'TRC_START_TIME','TRC_END_TIME', 'TRC_CU_EXT_PROGR'
    ,'TRC_FL_PHASE','MAT_CODE','WM_NAME' )) def get_child_materials_tree(parent_so, parent_cu, level=1): child_nodes=[]
    if trc_fl_phase=='P' : parent_links=WMS_TRACEABILITY_CU.objects.filter( CHILD_SO_CODE=parent_so,
    CHILD_CU_EXT_PROGR=parent_cu ).values('SO_CODE', 'CU_EXT_PROGR' ) for link in parent_links: child_so=link['SO_CODE']
    child_cu=link['CU_EXT_PROGR'] if not child_so or not child_cu: continue # Baris1 detail (phase P)
    detail1=WMS_TRACEABILITY.objects.filter( TRC_SO_CODE=child_so, TRC_CU_EXT_PROGR=child_cu, TRC_FL_PHASE='P'
    ).annotate( MAT_CODE=Subquery(MD_MATERIALS.objects.filter( MAT_SAP_CODE=OuterRef('TRC_MAT_SAP_CODE')
    ).values('MAT_CODE')[:1]), WM_NAME=Subquery(MD_WORKERS.objects.filter( WM_CODE=OuterRef('TRC_WM_CODE')
    ).values('WM_NAME')[:1]) ).values( 'TRC_PP_CODE' , 'TRC_MCH_CODE' , 'TRC_SO_CODE' , 'TRC_MAT_SAP_CODE'
    , 'TRC_WM_CODE' , 'TRC_START_TIME' , 'TRC_END_TIME' , 'TRC_CU_EXT_PROGR' , 'TRC_FL_PHASE' , 'MAT_CODE' , 'WM_NAME'
    ).first() # Baris2 detail (phase C) - ambil SEMUA baris2 tanpa filter shift
    details2=list(WMS_TRACEABILITY.objects.filter( TRC_SO_CODE=child_so, TRC_CU_EXT_PROGR=child_cu, TRC_FL_PHASE='C'
    ).annotate( MAT_CODE=Subquery(MD_MATERIALS.objects.filter( MAT_SAP_CODE=OuterRef('TRC_MAT_SAP_CODE')
    ).values('MAT_CODE')[:1]), WM_NAME=Subquery(MD_WORKERS.objects.filter( WM_CODE=OuterRef('TRC_WM_CODE')
    ).values('WM_NAME')[:1]) ).values( 'TRC_PP_CODE' , 'TRC_MCH_CODE' , 'TRC_SO_CODE' , 'TRC_MAT_SAP_CODE'
    , 'TRC_WM_CODE' , 'TRC_START_TIME' , 'TRC_END_TIME' , 'TRC_CU_EXT_PROGR' , 'TRC_FL_PHASE' , 'MAT_CODE' , 'WM_NAME'
    )) if detail1: node={ 'type' : 'root' , 'level' : level, 'baris1' : detail1, 'baris2_list' : details2 # Ini list
    semua baris2 } child_nodes.append(node) child_nodes +=get_child_materials_tree(child_so, child_cu, level + 1) else:
    # Logic lama untuk phase selain 'P' parent_links=WMS_TRACEABILITY_CU.objects.filter( SO_CODE=parent_so,
    CU_EXT_PROGR=parent_cu ).values('CHILD_SO_CODE', 'CHILD_CU_EXT_PROGR' ) for link in parent_links:
    child_so=link['CHILD_SO_CODE'] child_cu=link['CHILD_CU_EXT_PROGR'] if not child_so or not child_cu: continue
    detail1=WMS_TRACEABILITY.objects.filter( TRC_SO_CODE=child_so, TRC_CU_EXT_PROGR=child_cu, TRC_FL_PHASE='C'
    ).annotate( MAT_CODE=Subquery(MD_MATERIALS.objects.filter( MAT_SAP_CODE=OuterRef('TRC_MAT_SAP_CODE')
    ).values('MAT_CODE')[:1]), WM_NAME=Subquery(MD_WORKERS.objects.filter( WM_CODE=OuterRef('TRC_WM_CODE')
    ).values('WM_NAME')[:1]) ).values( 'TRC_PP_CODE' , 'TRC_MCH_CODE' , 'TRC_SO_CODE' , 'TRC_MAT_SAP_CODE'
    , 'TRC_WM_CODE' , 'TRC_START_TIME' , 'TRC_END_TIME' , 'TRC_CU_EXT_PROGR' , 'TRC_FL_PHASE' , 'MAT_CODE' , 'WM_NAME'
    ).first() detail2=None if detail1: other_phase='P' if detail1['TRC_FL_PHASE']=='C' else 'C'
    detail2=WMS_TRACEABILITY.objects.filter( TRC_SO_CODE=child_so, TRC_CU_EXT_PROGR=child_cu, TRC_FL_PHASE=other_phase
    ).annotate( MAT_CODE=Subquery(MD_MATERIALS.objects.filter( MAT_SAP_CODE=OuterRef('TRC_MAT_SAP_CODE')
    ).values('MAT_CODE')[:1]), WM_NAME=Subquery(MD_WORKERS.objects.filter( WM_CODE=OuterRef('TRC_WM_CODE')
    ).values('WM_NAME')[:1]) ).values( 'TRC_PP_CODE' , 'TRC_MCH_CODE' , 'TRC_SO_CODE' , 'TRC_MAT_SAP_CODE'
    , 'TRC_WM_CODE' , 'TRC_START_TIME' , 'TRC_END_TIME' , 'TRC_CU_EXT_PROGR' , 'TRC_FL_PHASE' , 'MAT_CODE' , 'WM_NAME'
    ).first() if detail1: node={ 'type' : 'root' , 'level' : level, 'baris1' : detail1, 'baris2' : detail2 }
    child_nodes.append(node) child_nodes +=get_child_materials_tree(child_so, child_cu, level + 1) return child_nodes #
    Build root nodes for item in traceability_raw: baris1_phase, baris2_phase=('C','P') if trc_fl_phase=='C' else
    ('P','C') if item['TRC_FL_PHASE']==baris1_phase: baris1=item if trc_fl_phase=='P' : # Ambil semua baris2 phase C
    tanpa filter shift baris2_list=list(WMS_TRACEABILITY.objects.filter( TRC_SO_CODE=item['TRC_SO_CODE'],
    TRC_CU_EXT_PROGR=item['TRC_CU_EXT_PROGR'], TRC_FL_PHASE='C' ).annotate(
    MAT_CODE=Subquery(MD_MATERIALS.objects.filter(MAT_SAP_CODE=OuterRef('TRC_MAT_SAP_CODE')).values('MAT_CODE')[:1]),
    WM_NAME=Subquery(MD_WORKERS.objects.filter(WM_CODE=OuterRef('TRC_WM_CODE')).values('WM_NAME')[:1])
    ).values( 'TRC_PP_CODE' ,'TRC_MCH_CODE','TRC_SO_CODE', 'TRC_MAT_SAP_CODE'
    ,'TRC_WM_CODE','TRC_START_TIME', 'TRC_END_TIME' ,'TRC_CU_EXT_PROGR','TRC_FL_PHASE','MAT_CODE','WM_NAME' )) else:
    baris2=WMS_TRACEABILITY.objects.filter( TRC_SO_CODE=item['TRC_SO_CODE'], TRC_CU_EXT_PROGR=item['TRC_CU_EXT_PROGR'],
    TRC_FL_PHASE=baris2_phase ).annotate(
    MAT_CODE=Subquery(MD_MATERIALS.objects.filter(MAT_SAP_CODE=OuterRef('TRC_MAT_SAP_CODE')).values('MAT_CODE')[:1]),
    WM_NAME=Subquery(MD_WORKERS.objects.filter(WM_CODE=OuterRef('TRC_WM_CODE')).values('WM_NAME')[:1])
    ).values( 'TRC_PP_CODE' ,'TRC_MCH_CODE','TRC_SO_CODE', 'TRC_MAT_SAP_CODE'
    ,'TRC_WM_CODE','TRC_START_TIME', 'TRC_END_TIME' ,'TRC_CU_EXT_PROGR','TRC_FL_PHASE','MAT_CODE','WM_NAME' ).first()
    node={ 'type' : 'root' , 'level' : 0, 'baris1' : baris1, } if trc_fl_phase=='P' : node['baris2_list']=baris2_list #
    list semua baris2 tanpa filter shift else: node['baris2']=baris2 traceability_materials.append(node)
    traceability_materials +=get_child_materials_tree(item['TRC_SO_CODE'], item['TRC_CU_EXT_PROGR'], level=1)
    context={ 'sfc_list' : sfc_list, 'material_list' : material_list, 'phase_list' : phase, 'date_shift_choices' :
    date_shift_choices, 'traceability_materials' : traceability_materials, 'selected_sfc_code' :
    sfc_code, 'selected_mat_info' : mat_info, 'selected_start_date' : start_date_raw, 'selected_end_date' :
    end_date_raw, 'selected_phase' : trc_fl_phase, } return render(request, 'traceability_by_materials.html' , context)
    # ada kondisi dimana ketika baris2 ada lebih dari satu dan memiliki child child harus berada di bawah baris2 itu
    jadi baris 2 punya icon panah untuk membuka child yang berisi baris 1 dan baris 2 # ROOT 1 - Baris1 A # - Baris2 A1
    # - Child dari Baris2 A1 # - Baris2 A2 # - Child dari Baris2 A2 #=======================TRACEABILITY
    MATERIALS==========================def traceability_by_materials(request): allowed_sfc_code=['C0', 'CC' , 'CE'
    , 'CP' , 'CX' , 'FB' , 'RC' , 'TB' , 'TT' ] # ------------ Parameter Pemanggilan ------------
    sfc_code=request.GET.get('sfc_code') mat_info=request.GET.get('mat_info')
    start_date_raw=request.GET.get('start_date') end_date_raw=request.GET.get('end_date')
    trc_fl_phase=request.GET.get('trc_fl_phase') # --- helper parse tanggal|shift --- def parse_date_shift(raw_value):
    if not raw_value: return None, None try: date_part, shift_part=raw_value.split('|')
    date_obj=datetime.strptime(date_part, "%Y-%m-%d" ).date() return date_obj, int(shift_part) except Exception: return
    None, None start_date, start_shift=parse_date_shift(start_date_raw) end_date,
    end_shift=parse_date_shift(end_date_raw) def hour_to_shift(hour): if 0 <=hour < 8: return 1 if 8 <=hour < 16: return
    2 return 3 # --- 1) Dropdown SFC --- sfc_list=( MD_SEMI_FINISHED_CLASSES.objects
    .filter(SFC_CODE__in=allowed_sfc_code) .values('SFC_CODE', 'SFC_DESC' ) .distinct() .order_by('SFC_CODE') ) # --- 2)
    Dropdown Materials --- material_list=[] if sfc_code: wms_mats=( WMS_TRACEABILITY.objects
    .filter(TRC_MAT_SAP_CODE__isnull=False, TRC_MAT_SAP_CODE__gt='' ) .values('TRC_MAT_SAP_CODE', 'TRC_CNT_CODE'
    , 'TRC_MAT_VARIANT' ) .distinct() .order_by('TRC_MAT_SAP_CODE') ) for mat in wms_mats: if
    MD_MATERIALS.objects.filter( MAT_SAP_CODE=mat['TRC_MAT_SAP_CODE'], SFC_CODE=sfc_code ).exists():
    mat_detail=MD_MATERIALS.objects.filter( MAT_SAP_CODE=mat['TRC_MAT_SAP_CODE'] ).values('MAT_CODE', 'MAT_DESC'
    ).first() material_list.append({ 'TRC_MAT_SAP_CODE' : mat['TRC_MAT_SAP_CODE'], 'TRC_CNT_CODE' :
    mat['TRC_CNT_CODE'], 'TRC_MAT_VARIANT' : mat['TRC_MAT_VARIANT'], 'MAT_CODE' : mat_detail['MAT_CODE'] if mat_detail
    else '' , 'MAT_DESC' : mat_detail['MAT_DESC'] if mat_detail else '' , }) # --- 3) Dropdown Phase --- phase=(
    WMS_TRACEABILITY.objects .values('TRC_FL_PHASE') .distinct() .order_by('TRC_FL_PHASE') ) # --- 4) Dropdown
    Date+Shift --- date_shift_choices=[] date_shift_raw_qs=( WMS_TRACEABILITY.objects
    .annotate(date=TruncDate('TRC_START_TIME')) .annotate(hour=ExtractHour('TRC_START_TIME')) .values('date', 'hour' )
    .distinct() .order_by('-date', 'hour' ) ) seen=set() for rec in date_shift_raw_qs: date=rec.get('date')
    hour=rec.get('hour') if date is None or hour is None: continue shift=hour_to_shift(hour) key=(date, shift) if key in
    seen: continue seen.add(key) label=f"{date.strftime('%d/%m/%Y')} - Shift {shift}"
    value=f"{date.isoformat()}|{shift}" date_shift_choices.append({'value': value, 'label' : label}) # ----- Default
    kosong ----- traceability_materials=[] # --- 5) Build Traceability Tree --- if sfc_code and mat_info and start_date
    and end_date and trc_fl_phase: # Query utama traceability_qs=( WMS_TRACEABILITY.objects
    .filter(TRC_MAT_SAP_CODE=mat_info) .filter(TRC_START_TIME__date__range=(start_date, end_date))
    .filter(TRC_FL_PHASE=trc_fl_phase) .order_by('TRC_START_TIME') ) # Filter shift (time and date) if start_shift:
    shift_start=None shift_end=None if start_shift==1: shift_start=datetime.combine(start_date, time(0, 0, 0))
    shift_end=datetime.combine(start_date, time(8, 0, 0)) elif start_shift==2: shift_start=datetime.combine(start_date,
    time(8, 0, 0)) shift_end=datetime.combine(start_date, time(16, 0, 0)) elif start_shift==3:
    shift_start=datetime.combine(start_date, time(16, 0, 0)) # shift_end di hari berikutnya jam 00:00, berarti sampai
    23:59:59 shift_end=datetime.combine(start_date + timedelta(days=1), time(0, 0, 0)) if shift_start and shift_end:
    traceability_qs=traceability_qs.filter( Q(TRC_END_TIME__gte=shift_start, TRC_START_TIME__lte=shift_end) |
    Q(TRC_START_TIME__range=(shift_start, shift_end)) | Q(TRC_END_TIME__range=(shift_start, shift_end)) ) # Annotasi
    MAT_CODE dan WM_NAME traceability_qs=traceability_qs.annotate( MAT_CODE=Subquery(
    MD_MATERIALS.objects.filter(MAT_SAP_CODE=OuterRef('TRC_MAT_SAP_CODE')).values('MAT_CODE')[:1] ), WM_NAME=Subquery(
    MD_WORKERS.objects.filter(WM_CODE=OuterRef('TRC_WM_CODE')).values('WM_NAME')[:1] ) )
    traceability_raw=list(traceability_qs.values( 'TRC_PP_CODE' ,'TRC_MCH_CODE','TRC_SO_CODE', 'TRC_MAT_SAP_CODE'
    ,'TRC_CNT_CODE','TRC_MAT_VARIANT', 'TRC_WM_CODE' ,'TRC_START_TIME','TRC_END_TIME', 'TRC_CU_EXT_PROGR'
    ,'TRC_FL_PHASE','MAT_CODE','WM_NAME' )) #===Rekursi Traceability Tree===def get_child_materials_tree(parent_so,
    parent_cu, level=1): child_nodes=[] if trc_fl_phase=='P' : parent_links=WMS_TRACEABILITY_CU.objects.filter(
    CHILD_SO_CODE=parent_so, CHILD_CU_EXT_PROGR=parent_cu ).values('SO_CODE', 'CU_EXT_PROGR' ) for link in parent_links:
    child_so=link['SO_CODE'] child_cu=link['CU_EXT_PROGR'] if not child_so or not child_cu: continue #=========Ambil
    detail baris1 (FL_PHASE='P' )==========detail1=WMS_TRACEABILITY.objects.filter( TRC_SO_CODE=child_so,
    TRC_CU_EXT_PROGR=child_cu, TRC_FL_PHASE='P' ).annotate( MAT_CODE=Subquery(MD_MATERIALS.objects.filter(
    MAT_SAP_CODE=OuterRef('TRC_MAT_SAP_CODE') ).values('MAT_CODE')[:1]), WM_NAME=Subquery(MD_WORKERS.objects.filter(
    WM_CODE=OuterRef('TRC_WM_CODE') ).values('WM_NAME')[:1]) ).values( 'TRC_PP_CODE' , 'TRC_MCH_CODE' , 'TRC_SO_CODE'
    , 'TRC_MAT_SAP_CODE' , 'TRC_WM_CODE' , 'TRC_START_TIME' , 'TRC_END_TIME' , 'TRC_CU_EXT_PROGR' , 'TRC_FL_PHASE'
    , 'MAT_CODE' , 'WM_NAME' ).first() #========Ambil detail baris2 (FL_PHASE='C'
    )===========detail2=WMS_TRACEABILITY.objects.filter( TRC_SO_CODE=child_so, TRC_CU_EXT_PROGR=child_cu,
    TRC_FL_PHASE='C' ).annotate( MAT_CODE=Subquery(MD_MATERIALS.objects.filter(
    MAT_SAP_CODE=OuterRef('TRC_MAT_SAP_CODE') ).values('MAT_CODE')[:1]), WM_NAME=Subquery(MD_WORKERS.objects.filter(
    WM_CODE=OuterRef('TRC_WM_CODE') ).values('WM_NAME')[:1]) ).values( 'TRC_PP_CODE' , 'TRC_MCH_CODE' , 'TRC_SO_CODE'
    , 'TRC_MAT_SAP_CODE' , 'TRC_WM_CODE' , 'TRC_START_TIME' , 'TRC_END_TIME' , 'TRC_CU_EXT_PROGR' , 'TRC_FL_PHASE'
    , 'MAT_CODE' , 'WM_NAME' ).first() if detail1: node={ 'type' : 'root' , 'level' : level, 'baris1' :
    detail1, 'baris2' : detail2 } child_nodes.append(node) # Rekursif ke child dari data baru child_nodes
    +=get_child_materials_tree(child_so, child_cu, level + 1) else: # Phase C - logika lama tetap
    parent_links=WMS_TRACEABILITY_CU.objects.filter( SO_CODE=parent_so, CU_EXT_PROGR=parent_cu
    ).values('CHILD_SO_CODE', 'CHILD_CU_EXT_PROGR' ) for link in parent_links: child_so=link['CHILD_SO_CODE']
    child_cu=link['CHILD_CU_EXT_PROGR'] if not child_so or not child_cu: continue
    detail1=WMS_TRACEABILITY.objects.filter( TRC_SO_CODE=child_so, TRC_CU_EXT_PROGR=child_cu, TRC_FL_PHASE='C'
    ).annotate( MAT_CODE=Subquery(MD_MATERIALS.objects.filter( MAT_SAP_CODE=OuterRef('TRC_MAT_SAP_CODE')
    ).values('MAT_CODE')[:1]), WM_NAME=Subquery(MD_WORKERS.objects.filter( WM_CODE=OuterRef('TRC_WM_CODE')
    ).values('WM_NAME')[:1]) ).values( 'TRC_PP_CODE' , 'TRC_MCH_CODE' , 'TRC_SO_CODE' , 'TRC_MAT_SAP_CODE'
    , 'TRC_WM_CODE' , 'TRC_START_TIME' , 'TRC_END_TIME' , 'TRC_CU_EXT_PROGR' , 'TRC_FL_PHASE' , 'MAT_CODE' , 'WM_NAME'
    ).first() detail2=None if detail1: other_phase='P' if detail1['TRC_FL_PHASE']=='C' else 'C'
    detail2=WMS_TRACEABILITY.objects.filter( TRC_SO_CODE=child_so, TRC_CU_EXT_PROGR=child_cu, TRC_FL_PHASE=other_phase
    ).annotate( MAT_CODE=Subquery(MD_MATERIALS.objects.filter( MAT_SAP_CODE=OuterRef('TRC_MAT_SAP_CODE')
    ).values('MAT_CODE')[:1]), WM_NAME=Subquery(MD_WORKERS.objects.filter( WM_CODE=OuterRef('TRC_WM_CODE')
    ).values('WM_NAME')[:1]) ).values( 'TRC_PP_CODE' , 'TRC_MCH_CODE' , 'TRC_SO_CODE' , 'TRC_MAT_SAP_CODE'
    , 'TRC_WM_CODE' , 'TRC_START_TIME' , 'TRC_END_TIME' , 'TRC_CU_EXT_PROGR' , 'TRC_FL_PHASE' , 'MAT_CODE' , 'WM_NAME'
    ).first() if detail1: node={ 'type' : 'root' , 'level' : level, 'baris1' : detail1, 'baris2' : detail2 }
    child_nodes.append(node) child_nodes +=get_child_materials_tree(child_so, child_cu, level + 1) return child_nodes
    #===BUILD ROOT & CHILD KALO FL PHASE ( VIEW DATA BUILD P==C OR C==P)===for item in traceability_raw: baris1_phase,
    baris2_phase=('C','P') if trc_fl_phase=='C' else ('P','C') if item['TRC_FL_PHASE']==baris1_phase: baris1=item
    baris2=WMS_TRACEABILITY.objects.filter( TRC_SO_CODE=item['TRC_SO_CODE'], TRC_CU_EXT_PROGR=item['TRC_CU_EXT_PROGR'],
    TRC_FL_PHASE=baris2_phase ).annotate(
    MAT_CODE=Subquery(MD_MATERIALS.objects.filter(MAT_SAP_CODE=OuterRef('TRC_MAT_SAP_CODE')).values('MAT_CODE')[:1]),
    WM_NAME=Subquery(MD_WORKERS.objects.filter(WM_CODE=OuterRef('TRC_WM_CODE')).values('WM_NAME')[:1])
    ).values( 'TRC_PP_CODE' ,'TRC_MCH_CODE','TRC_SO_CODE', 'TRC_MAT_SAP_CODE'
    ,'TRC_WM_CODE','TRC_START_TIME', 'TRC_END_TIME' ,'TRC_CU_EXT_PROGR','TRC_FL_PHASE','MAT_CODE','WM_NAME' ).first()
    node={ 'type' : 'root' , 'level' : 0, 'baris1' : baris1, 'baris2' : baris2 } traceability_materials.append(node)
    traceability_materials +=get_child_materials_tree(item['TRC_SO_CODE'], item['TRC_CU_EXT_PROGR'], level=1)
    context={ 'sfc_list' : sfc_list, 'material_list' : material_list, 'phase' : phase, 'date_shift_choices' :
    date_shift_choices, 'traceability_materials' : traceability_materials, 'selected_sfc' :
    sfc_code, 'selected_mat_info' : mat_info, 'selected_start_date' : start_date_raw, 'selected_end_date' :
    end_date_raw, 'selected_phase' : trc_fl_phase, } return render(request, 'traceability_by_materials.html' , context)
    {% extends "templates2/index.html" %} {% block content %} <style>
    .material-item {
    display: none;
    }

    .level-1 {
    margin-left: 1em;
    }

    .level-2 {
    margin-left: 4em;
    }

    .level-3 {
    margin-left: 8em;
    }

    .level-4 {
    margin-left: 12em;
    }

    .level-5 {
    margin-left: 16em;
    }

    .level-6 {
    margin-left: 20em;
    }

    .baris2 {
    border-radius: 7px;
    margin-left: 2em;
    display: inline-block;
    background-color: rgba(0, 149, 255, 0.448);
    padding: 2px 4px;
    }
    </style>

    <!-- contant -->
    <div class="container mt-4">
        <h3 class="judul mb-4">By Materials</h3>
        <!-- Filter -->
        <div class="container mt-4">
            <div class="card mb-4 shadow-sm">
                <div class="card-body">
                    <form method="get" action="traceability_by_materials" class="row g-3" id="filterForm">

                        <!-- Semifinished -->
                        <div class="col-md-4">
                            <label for="sfc" class="form-label fw-bold">Semifinished Class :</label>
                            <select name="sfc_code" id="sfc" class="form-select" onchange="this.form.submit()">
                                <option value="">-- Select SF --</option>
                                {% for sfc in sfc_list %}
                                <option value="{{ sfc.SFC_CODE }}"
                                    {% if sfc.SFC_CODE == selected_sfc %}selected{% endif %}>
                                    {{ sfc.SFC_CODE }} - {{ sfc.SFC_DESC }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Materials -->
                        <div class="col-md-4">
                            <label for="mat" class="form-label fw-bold">Materials :</label>
                            <select name="mat_info" id="mat" class="form-select" onchange="this.form.submit()">
                                <option value="">-- Select Materials --</option>
                                {% for m in material_list %}
                                <option value="{{ m.TRC_MAT_SAP_CODE }}"
                                    {% if m.TRC_MAT_SAP_CODE == selected_mat_info %}selected{% endif %}>
                                    {{ m.TRC_MAT_SAP_CODE }} - {{ m.TRC_CNT_CODE }} - {{ m.TRC_MAT_VARIANT }}
                                    ({{ m.MAT_CODE }} {{ m.MAT_DESC }})
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- FL Phase -->
                        <div class="col-md-4">
                            <label for="trc_fl_phase" class="form-label fw-bold">FL Phase :</label>
                            <select name="trc_fl_phase" id="trc_fl_phase" class="form-select"
                                onchange="this.form.submit()">
                                <option value="">-- Select FL Phase --</option>
                                {% for p in phase %}
                                <option value="{{ p.TRC_FL_PHASE }}"
                                    {% if p.TRC_FL_PHASE == selected_phase %}selected{% endif %}>
                                    {% if p.TRC_FL_PHASE == "C" %}C (Consumed)
                                    {% elif p.TRC_FL_PHASE == "P" %}P (Produced)
                                    {% else %}{{ p.TRC_FL_PHASE }}{% endif %}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Start Date -->
                        <div class="col-md-4">
                            <label for="start_date" class="form-label fw-bold">From :</label>
                            <select name="start_date" id="start_date" class="form-select" onchange="this.form.submit()">
                                <option value="">-- Select Date & Shift --</option>
                                {% for opt in date_shift_choices %}
                                <option value="{{ opt.value }}"
                                    {% if selected_start_date == opt.value %}selected{% endif %}>
                                    {{ opt.label }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- End Date -->
                        <div class="col-md-4">
                            <label for="end_date" class="form-label fw-bold">To :</label>
                            <select name="end_date" id="end_date" class="form-select" onchange="this.form.submit()">
                                <option value="">-- Select Date & Shift --</option>
                                {% for opt in date_shift_choices %}
                                <option value="{{ opt.value }}"
                                    {% if selected_end_date == opt.value %}selected{% endif %}>
                                    {{ opt.label }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </form>

                    <!-- Tombol Reset -->
                    <div class="row mt-4">
                        <div class="col-md-12">
                            <a href="traceability_by_materials" class="btn btn-primary btn-reset">Reset</a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- traceability views by materials-->
            {% if traceability_materials %}
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title mb-3">Traceability Views</h5>
                    <div id="material-tree">
                        {% for row in traceability_materials %}
                        <div class="material-item level-{{ row.level|add:1 }} mb-1">
                            <div data-bs-spy="scroll" data-bs-target="#list-example" data-bs-offset="0"
                                class="scrollspy-example" tabindex="0">
                                <button class="toggle-btn" data-id="{{ forloop.counter }}">▶</button>
                                <!-- traceability views by machine -->
                                {% if row.type == "root" %}
                                <!-- Root node -->
                                {{ row.baris1.TRC_SO_CODE }}
                                {{ row.baris1.TRC_CU_EXT_PROGR }} -
                                {{ row.baris1.MAT_CODE }} -
                                {{ row.baris1.TRC_MAT_SAP_CODE }} -
                                ({{ row.baris1.TRC_START_TIME }} -
                                {{ row.baris1.TRC_END_TIME }}) -
                                ({{ row.baris1.TRC_WM_CODE }} -
                                {{ row.baris1.WM_NAME }})
                                <br>
                                {% if row.baris2_list %}
                                {% for b2 in row.baris2_list %}
                                <div class="baris2">
                                    {{ b2.TRC_PP_CODE }} -
                                    {{ b2.TRC_MCH_CODE }} -
                                    ({{ b2.TRC_START_TIME }} - {{ b2.TRC_END_TIME }}) -
                                    ({{ b2.TRC_WM_CODE }} - {{ b2.WM_NAME }})
                                </div>
                                {% endfor %}
                                {% endif %}
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    <!-- end contant -->

    <!-- JS  -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/2.3.2/js/dataTables.js"></script>
    <script src="https://cdn.datatables.net/buttons/3.2.4/js/dataTables.buttons.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
    <script src="https://cdn.datatables.net/buttons/3.2.4/js/buttons.html5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>


    <!-- JAVA SCRIPT LINE CHILD -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // Tampilkan semua level-1 (root)
            document.querySelectorAll(".material-item.level-1").forEach(item => item.style.display = "block");
            document.querySelectorAll(".toggle-btn").forEach(btn => {
                btn.addEventListener("click", function () {
                    let currentItem = this.parentElement.parentElement;
                    let currentLevel = parseInt(currentItem.className.match(/level-(\d+)/)[1]);
                    let next = currentItem.nextElementSibling;
                    let isExpanding = this.textContent === "▶";
                    this.textContent = isExpanding ? "▼" : "▶";
                    while (next && next.classList.contains("material-item")) {
                        let level = parseInt(next.className.match(/level-(\d+)/)[1]);
                        if (level <= currentLevel) break;
                        if (level === currentLevel + 1) {
                            next.style.display = isExpanding ? "block" : "none";
                        }
                        if (!isExpanding && level > currentLevel) {
                            let toggle = next.querySelector(".toggle-btn");
                            if (toggle) toggle.textContent = "▶";
                            next.style.display = "none";
                        }
                        next = next.nextElementSibling;
                    }
                });
            });
        });
    </script>


    <!-- JS SELECT2-->
    <script>
        $('#mat').select2();
        $('#sfc').select2();
        $('#trc_fl_phase').select2();
        $('#start_date').select2();
        $('#end_date').select2();
    </script>

    {% endblock %}





    <!-- 
1. menu machine (Building gada FL PHASE P)
2. Menu machine (S02 tidak ada FL PHASE C)
3. Tidak ada loading setelah pilih filter
4. SEMUA MENU (data yang tampil di urutkan berdasarkan data yang paling lama) 
5. Menu Materials ketika FL_PHASE = 'C' itu sudah benar, 
tetapi ketika FL_PHASE ='P' data baris2 tidak terfilter berdasarkan shift atau jam. seharusnya diambil berdasarkan baris1 yang memiliki status C, misal baris1 memiliki baris2 2 data 
ROOT 1 - Baris1 A
    - Baris2 A1
        - Child dari Baris2 A1
    - Baris2 A2
        - Child dari Baris2 A2
maka harus tampil semua sepeti perumpamaan ku diatas. 
notes kalo yang FL_PHASE = 'C' itu sudah benar menggunakan pengaturan tanggal jam dan lainnya data yang tampil juga sudah benar. 

6. Menu CU sama seperti menu materials

ALUR FORM MATERIALS
1. Pilih form tanggal
2. pilih form FL PHASE
3. Pilih form semifinished class 
4. Pilih form materials (form ini tampil berdasarkan tanggal dan form semifinished terpilih)
5. Lalu data tampil berdasarkan tanggal, form materials, dan fl phase
6. Apabila FL_PHASE = 'C' maka data yang tampil ADA BARIS 1 DAN BARIS 2. BARIS 1 YANG BERSATATUS C DAN BARIS2 YANG BERSTATUS P. 
7.  Apabila FL_PHASE = 'P' maka data yang tampil ADA BARIS 1 DAN BARIS 2. BARIS 1 YANG BERSATATUS P DAN BARIS2 YANG BERSTATUS C.
8. Apabila ketika di baris 2 memiliki data lebih dari 1 maka data tersebut harus di tampilkan. 
9. baris2 ditampilkan tidak sesuai dengan tanggal yang terpilih jadi apabila tanggal baris2 keluar dari tanggal terfilter tetap di tampilkan karena baris 2 mengikuti baris 1 
---CONTOH---
ROOT 1 - Baris1 A
            - Baris2 A1
                - Child dari Baris2 A1
            - Baris2 A2
                - Child dari Baris2 A2



---- PENGATURAN DATA FORM BERDASARKAN FILTER TANGGAL ----

SELECT [TRC_MCH_CODE]
FROM [PCS].[dbo].[WMS_TRACEABILITY] 
	WHERE
	TRC_PP_CODE = 'S04'
	AND
    ((TRC_END_TIME = '2025-10-08 00:00:00' AND TRC_END_TIME < '2025-10-08 08:00:00')
OR

(TRC_START_TIME > '2025-10-08 00:00:00' AND TRC_START_TIME < '2025-10-08 08:00:00'))







SELECT TRC_MAT_SAP_CODE
FROM [PCS].[dbo].[WMS_TRACEABILITY] 
WHERE 
TRC_FL_PHASE IN ('P', 'C')
AND (
-- Logika 1: Overlapping waktu dengan range 1
NOT (
TRC_END_TIME < '2025-10-04 00:00:00' OR
TRC_START_TIME > '2025-10-04 08:00:00'
)
OR
-- Logika 2: waktu start atau end ada di range 2
(
(TRC_END_TIME > '2025-10-04 00:00:00' AND TRC_END_TIME < '2025-10-04 08:00:00')
OR
(TRC_START_TIME > '2025-10-04 00:00:00' AND TRC_START_TIME < '2025-10-04 08:00:00')
)
)
GROUP BY TRC_MAT_SAP_CODE
HAVING 
SUM(CASE WHEN TRC_FL_PHASE = 'P' THEN 1 ELSE 0 END) > 1
AND
SUM(CASE WHEN TRC_FL_PHASE = 'C' THEN 1 ELSE 0 END) > 1;

-->
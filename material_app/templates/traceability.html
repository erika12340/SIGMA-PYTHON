{% extends "templates2/index.html" %}
{% block content %}

<div class="container">
    <h3 style="margin-left: 30px ;">Traceability Views</h3>

    <!-- Navbar -->
    <nav>
        <div class="nav nav-tabs" id="nav-tab" role="tablist">
            
            <button class="nav-link active" id="nav-RBMachine-tab" data-bs-toggle="tab" data-bs-target="#nav-RBMachine"
                type="button" role="tab" aria-controls="nav-RBMachine" aria-selected="true">By RBMachine</button>

            <button class="nav-link" id="nav-CU-tab" data-bs-toggle="tab" data-bs-target="#nav-CU"
                type="button" role="tab" aria-controls="nav-CU" aria-selected="false">By CU</button>

            <button class="nav-link" id="nav-Material-tab" data-bs-toggle="tab" data-bs-target="#nav-Material"
                type="button" role="tab" aria-controls="nav-Material" aria-selected="false">By Material</button>

        </div>
    </nav>
    <!-- /Navbar -->

    <!-- Tab Content -->
    <div class="tab-content" id="nav-tabContent">

        <!-- TAB: By RBMachine -->
        <div class="tab-pane fade show active" id="nav-RBMachine" role="tabpanel" aria-labelledby="nav-RBMachine-tab">
            <div class="container mt-4">
                <h3 class="mb-4">By RBMachine</h3>

                <div class="card mb-4 shadow-sm">
                    <div class="card-body">
                        <!-- Filter Form -->
                        <form method="get" action="{% url 'data_produksi' %}" class="row g-3" id="filterForm">
                            <div class="col-md-4">
                                <label for="sfc" class="form-label fw-bold">Production Phase :</label>
                                <select name="sfc_code" id="sfc" class="form-select" onchange="this.form.submit()">
                                    <option value="">-- Pilih Phase --</option>
                                    {% for sfc in sfc_list %}
                                        <option value="{{ sfc.SFC_CODE }}" {% if sfc.SFC_CODE == selected_sfc %}selected{% endif %}>
                                            {{ sfc.SFC_CODE }} - {{ sfc.SFC_DESC }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="col-md-4">
                                <label for="mat" class="form-label fw-bold">Machine :</label>
                                <select name="mat_info" id="mat" class="form-select" onchange="this.form.submit()">
                                    <option value="">-- Pilih Machine --</option>
                                    {% for m in materials %}
                                        <option value="{{ m.MAT_CODE }}|{{ m.MAT_SAP_CODE }}|{{ m.MAT_VARIANT }}|{{ m.CNT_CODE }}"
                                            {% if selected_mat_info == m.MAT_CODE|stringformat:"s"|add:"|"|add:m.MAT_SAP_CODE|add:"|"|add:m.MAT_VARIANT|add:"|"|add:m.CNT_CODE %}selected{% endif %}>
                                            {{ m.MAT_CODE }} - {{ m.MAT_SAP_CODE }} - {{ m.CNT_CODE }} - {{ m.MAT_VARIANT }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="col-md-2">
                                <label for="start_date" class="form-label fw-bold">From :</label>
                                <input type="date" name="start_date" id="start_date" class="form-control"
                                    value="{{ selected_start_date|default:'' }}">
                            </div>

                            <div class="col-md-2">
                                <label for="end_date" class="form-label fw-bold">To :</label>
                                <input type="date" name="end_date" id="end_date" class="form-control"
                                    value="{{ selected_end_date|default:'' }}">
                            </div>
                        </form>

                        <div class="col-12 mt-3">
                            <a href="{% url 'data_produksi' %}" class="btn btn-secondary">Reset</a>
                        </div>
                    </div>
                </div>

                {% if error_message %}
                <div class="alert alert-warning alert-dismissible fade show" role="alert">
                    {{ error_message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                {% endif %}

                {% if material_data %}
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title mb-3">Daftar Material</h5>
                        <div id="material-tree">
                            {% for row in material_data %}
                            <div class="material-item level-{{ row.level|add:1 }} mb-1">
                                <button class="toggle-btn" data-id="{{ forloop.counter }}">▶</button>
                                <strong>{{ row.MT_CODE }}</strong> - {{ row.SFC_CODE }} ({{ row.SFC_DESC }}) - {{ row.MAT_CODE }} -
                                {{ row.CHILD_MAT_SAP_CODE }} - {{ row.CHILD_CNT_CODE }} - {{ row.MAT_VARIANT }} - {{ row.MAT_DESC }} -
                                {{ row.BOM_QUANTITY }} {{ row.MAT_MEASURE_UNIT }} -
                                <small class="text-muted">({{ row.BV_STATUS }})</small>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- TAB: By CU -->
        <div class="tab-pane fade" id="nav-CU" role="tabpanel" aria-labelledby="nav-profile-CU">
            <div class="container mt-4">
                <h2 class="mb-4">By CU</h2>

                {% if error_message %}
                <div class="alert alert-warning alert-dismissible fade show" role="alert">
                    {{ error_message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                {% endif %}

                <div class="card mb-4 shadow-sm">
                    <div class="card-body">
                        <form method="get" action="{% url 'data_produksi' %}" class="row g-3" id="filterForm">
                            <div class="col-md-4">
                                <label for="sfc" class="form-label fw-bold">Source:</label>
                                <select name="sfc_code" id="sfc" class="form-select" onchange="this.form.submit()">
                                    <option value="">-- Pilih Source --</option>
                                    {% for sfc in sfc_list %}
                                        <option value="{{ sfc.SFC_CODE }}" {% if sfc.SFC_CODE == selected_sfc %}selected{% endif %}>
                                            {{ sfc.SFC_CODE }} - {{ sfc.SFC_DESC }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="col-md-4">
                                <label for="mat" class="form-label fw-bold">Containment Unit :</label>
                                <select name="mat_info" id="mat" class="form-select" onchange="this.form.submit()">
                                    <option value="">-- Pilih Containment --</option>
                                    {% for m in materials %}
                                        <option value="{{ m.MAT_CODE }}|{{ m.MAT_SAP_CODE }}|{{ m.MAT_VARIANT }}|{{ m.CNT_CODE }}"
                                            {% if selected_mat_info == m.MAT_CODE|stringformat:"s"|add:"|"|add:m.MAT_SAP_CODE|add:"|"|add:m.MAT_VARIANT|add:"|"|add:m.CNT_CODE %}selected{% endif %}>
                                            {{ m.MAT_CODE }} - {{ m.MAT_SAP_CODE }} - {{ m.CNT_CODE }} - {{ m.MAT_VARIANT }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="col-md-2">
                                <label for="start_date" class="form-label fw-bold">From :</label>
                                <input type="date" name="start_date" id="start_date" class="form-control"
                                    value="{{ selected_start_date|default:'' }}">
                            </div>

                            <div class="col-md-2">
                                <label for="end_date" class="form-label fw-bold">To :</label>
                                <input type="date" name="end_date" id="end_date" class="form-control"
                                    value="{{ selected_end_date|default:'' }}">
                            </div>
                        </form>

                        <div class="col-12 mt-3">
                            <a href="{% url 'data_produksi' %}" class="btn btn-secondary">Reset</a>
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-body">
                        <form>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">CU</label>
                                    <input type="text" class="form-control" value="{{ material_detail.mat_desc }}" readonly>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Material</label>
                                    <input type="text" class="form-control" value="{{ material_detail.ip_code }}" readonly>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                {% if material_data %}
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title mb-3">Daftar Material</h5>
                        <div id="material-tree">
                            {% for row in material_data %}
                            <div class="material-item level-{{ row.level|add:1 }} mb-1">
                                <button class="toggle-btn" data-id="{{ forloop.counter }}">▶</button>
                                <strong>{{ row.MT_CODE }}</strong> - {{ row.SFC_CODE }} ({{ row.SFC_DESC }}) - {{ row.MAT_CODE }} -
                                {{ row.CHILD_MAT_SAP_CODE }} - {{ row.CHILD_CNT_CODE }} - {{ row.MAT_VARIANT }} - {{ row.MAT_DESC }} -
                                {{ row.BOM_QUANTITY }} {{ row.MAT_MEASURE_UNIT }} -
                                <small class="text-muted">({{ row.BV_STATUS }})</small>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- TAB: By Material -->
        <div class="tab-pane fade" id="nav-Material" role="tabpanel" aria-labelledby="nav-Material-tab">
            <div class="container mt-4">
                <h2 class="mb-4">By Materials</h2>

                <div class="card mb-4 shadow-sm">
                    <div class="card-body">
                        <form method="get" action="{% url 'data_produksi' %}" class="row g-3" id="filterForm">
                            <div class="col-md-4">
                                <label for="sfc" class="form-label fw-bold">Semifinished Class :</label>
                                <select name="sfc_code" id="sfc" class="form-select" onchange="this.form.submit()">
                                    <option value="">-- Pilih SF --</option>
                                    {% for sfc in sfc_list %}
                                        <option value="{{ sfc.SFC_CODE }}" {% if sfc.SFC_CODE == selected_sfc %}selected{% endif %}>
                                            {{ sfc.SFC_CODE }} - {{ sfc.SFC_DESC }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="col-md-4">
                                <label for="mat" class="form-label fw-bold">Materiale :</label>
                                <select name="mat_info" id="mat" class="form-select" onchange="this.form.submit()">
                                    <option value="">-- Pilih Materiale --</option>
                                    {% for m in materials %}
                                        <option value="{{ m.MAT_CODE }}|{{ m.MAT_SAP_CODE }}|{{ m.MAT_VARIANT }}|{{ m.CNT_CODE }}"
                                            {% if selected_mat_info == m.MAT_CODE|stringformat:"s"|add:"|"|add:m.MAT_SAP_CODE|add:"|"|add:m.MAT_VARIANT|add:"|"|add:m.CNT_CODE %}selected{% endif %}>
                                            {{ m.MAT_CODE }} - {{ m.MAT_SAP_CODE }} - {{ m.CNT_CODE }} - {{ m.MAT_VARIANT }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="col-md-2">
                                <label for="start_date" class="form-label fw-bold">From :</label>
                                <input type="date" name="start_date" id="start_date" class="form-control"
                                    value="{{ selected_start_date|default:'' }}">
                            </div>

                            <div class="col-md-2">
                                <label for="end_date" class="form-label fw-bold">To :</label>
                                <input type="date" name="end_date" id="end_date" class="form-control"
                                    value="{{ selected_end_date|default:'' }}">
                            </div>
                        </form>

                        <div class="col-12 mt-3">
                            <a href="{% url 'data_produksi' %}" class="btn btn-secondary">Reset</a>
                        </div>
                    </div>
                </div>

                {% if error_message %}
                <div class="alert alert-warning alert-dismissible fade show" role="alert">
                    {{ error_message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                {% endif %}

                {% if material_data %}
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title mb-3">Daftar Material</h5>
                        <div id="material-tree">
                            {% for row in material_data %}
                            <div class="material-item level-{{ row.level|add:1 }} mb-1">
                                <button class="toggle-btn" data-id="{{ forloop.counter }}">▶</button>
                                <strong>{{ row.MT_CODE }}</strong> - {{ row.SFC_CODE }} ({{ row.SFC_DESC }}) - {{ row.MAT_CODE }} -
                                {{ row.CHILD_MAT_SAP_CODE }} - {{ row.CHILD_CNT_CODE }} - {{ row.MAT_VARIANT }} - {{ row.MAT_DESC }} -
                                {{ row.BOM_QUANTITY }} {{ row.MAT_MEASURE_UNIT }} -
                                <small class="text-muted">({{ row.BV_STATUS }})</small>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q"
    crossorigin="anonymous"></script>

<!-- JS UNTUK LINE DATA MATERIAL -->
<script>
document.addEventListener("DOMContentLoaded", function() {
    // Tampilkan semua level-1 (root)
    document.querySelectorAll(".material-item.level-1").forEach(item => item.style.display = "block");

    document.querySelectorAll(".toggle-btn").forEach(btn => {
        btn.addEventListener("click", function() {
            let currentItem = this.parentElement;
            let currentLevel = parseInt(currentItem.className.match(/level-(\d+)/)[1]);
            let next = currentItem.nextElementSibling;
            let isExpanding = this.textContent === "▶";

            this.textContent = isExpanding ? "▼" : "▶";

            while (next && next.classList.contains("material-item")) {
                let level = parseInt(next.className.match(/level-(\d+)/)[1]);
                if (level <= currentLevel) break;
                if (level === currentLevel + 1) {
                    next.style.display = isExpanding ? "block" : "none";
                }
                if (!isExpanding && level > currentLevel) {
                    next.querySelector(".toggle-btn").textContent = "▶";
                }
                next = next.nextElementSibling;
            }
        });
    });
});
</script>

<!-- JS UNTUK FORM -->
<script>
    $('#sfc').select2();
    $('#mat').select2();
</script>

{% endblock %}
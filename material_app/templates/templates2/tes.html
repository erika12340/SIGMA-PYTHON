<!-- def traceability_by_machine(request):
    trc_code = request.GET.get('trc_code')
    mch_info = request.GET.get('mch_info')
    start_date_raw = request.GET.get('start_date')
    end_date_raw = request.GET.get('end_date')
    trc_fl_phase = request.GET.get('trc_fl_phase')

    def parse_date_shift(raw_value):
        try:
            date_part, shift_part = raw_value.split('|')
            return date_part, shift_part
        except:
            return None, None

    # Parse tanggal
    start_date, _ = parse_date_shift(start_date_raw)
    end_date, _ = parse_date_shift(end_date_raw)
    try:
        if start_date and end_date:
            start_date = datetime.strptime(start_date, "%Y-%m-%d").date()
            end_date = datetime.strptime(end_date, "%Y-%m-%d").date()
        else:
            start_date = end_date = None
    except ValueError:
        start_date = end_date = None

    # Ambil descriptor phase
    pp_desc_subquery = MD_PRODUCTION_PHASES.objects.filter(
        PP_CODE=OuterRef('TRC_PP_CODE')
    ).values('PP_DESC')[:1]

    trc_list = (
        WMS_TRACEABILITY.objects
        .annotate(PP_DESC=Subquery(pp_desc_subquery))
        .values('TRC_PP_CODE', 'PP_DESC')
        .distinct()
        .order_by('TRC_PP_CODE')
    )

    machines = []
    if trc_code:
        machines = (
            WMS_TRACEABILITY.objects
            .filter(TRC_PP_CODE=trc_code)
            .values('TRC_PP_CODE', 'TRC_MCH_CODE')
            .distinct()
            .order_by('TRC_MCH_CODE')
        )

    phase = (
        WMS_TRACEABILITY.objects
        .values('TRC_FL_PHASE')
        .distinct()
        .order_by('TRC_FL_PHASE')
    )

    date_shift_raw = (
        WMS_TRACEABILITY.objects
        .annotate(date=TruncDate('TRC_START_TIME'))
        .values('TRC_START_TIME', 'date')
        .annotate(shift=Subquery(
            DC_PRODUCTION_DATA.objects.filter(
                PS_START_PROD=OuterRef('TRC_START_TIME')
            ).values('SHF_CODE')[:1]
        ))
        .values('date', 'shift')
        .distinct()
        .order_by('-date')
    )
    date_shift_choices = [
        {'value': f"{d['date']}|{d['shift']}", 'label': f"{d['date'].strftime('%d/%m/%Y')} - {d['shift']}"}
        for d in date_shift_raw if d['shift']
    ]

    # Filter traceability utama
    traceability_raw = []
    if trc_code and mch_info and start_date and end_date and trc_fl_phase:
        traceability_qs = WMS_TRACEABILITY.objects.filter(
            TRC_START_TIME__date__range=(start_date, end_date)
        ).annotate(
            MAT_CODE=Subquery(
                MD_MATERIALS.objects.filter(
                    MAT_SAP_CODE=OuterRef('TRC_MAT_SAP_CODE')
                ).values('MAT_CODE')[:1]
            ),
            WM_CODE=Subquery(
                MD_WORKERS.objects.filter(
                    WM_CODE=OuterRef('TRC_WM_CODE')
                ).values('WM_CODE')[:1]
            ),
            WM_NAME=Subquery(
                MD_WORKERS.objects.filter(
                    WM_CODE=OuterRef('TRC_WM_CODE')
                ).values('WM_NAME')[:1]
            )
        )
        if trc_code:
            traceability_qs = traceability_qs.filter(TRC_PP_CODE=trc_code)
        if trc_fl_phase:
            traceability_qs = traceability_qs.filter(TRC_FL_PHASE=trc_fl_phase)
        if mch_info:
            try:
                trc_pp, trc_mch = mch_info.split('|')
                traceability_qs = traceability_qs.filter(
                    TRC_PP_CODE=trc_pp, TRC_MCH_CODE=trc_mch
                )
            except ValueError:
                pass

        traceability_raw = list(traceability_qs.values(
            'TRC_PP_CODE', 'TRC_MCH_CODE', 'TRC_SO_CODE', 'TRC_MAT_SAP_CODE',
            'TRC_WM_CODE', 'TRC_START_TIME', 'TRC_END_TIME', 'TRC_CU_EXT_PROGR',
            'MAT_CODE', 'WM_CODE', 'WM_NAME'
        ))

    # Fungsi bantu
    def get_pp_mch_wm_from_cu(cu_ext_progr):
        info = WMS_TRACEABILITY_CU.objects.filter(
            CU_EXT_PROGR=cu_ext_progr
        ).values('PP_CODE', 'MCH_CODE', 'PRODUCTION_DATE', 'WM_CODE').first()
        return info or {'PP_CODE': '', 'MCH_CODE': '', 'PRODUCTION_DATE': '', 'WM_CODE': ''}

    def get_worker_name(wm_code):
        if not wm_code:
            return ''
        worker = MD_WORKERS.objects.filter(WM_CODE=wm_code).values('WM_NAME').first()
        return worker['WM_NAME'] if worker else ''

    def get_child_cu_tree(parent_cu, level=1):
        child_data = []
        children = WMS_TRACEABILITY_CU.objects.filter(
            CHILD_CU_EXT_PROGR=parent_cu
        ).values('CHILD_CU_EXT_PROGR', 'PRODUCTION_DATE', 'PP_CODE', 'MCH_CODE', 'WM_CODE')

        for child in children:
            cu_ext = child['CHILD_CU_EXT_PROGR']
            info = get_pp_mch_wm_from_cu(cu_ext)
            operator = {'WM_CODE': info['WM_CODE'], 'WM_NAME': get_worker_name(info['WM_CODE'])}

            detail = WMS_TRACEABILITY.objects.filter(
                TRC_CU_EXT_PROGR=cu_ext
            ).annotate(
                MAT_CODE=Subquery(
                    MD_MATERIALS.objects.filter(
                        MAT_SAP_CODE=OuterRef('TRC_MAT_SAP_CODE')
                    ).values('MAT_CODE')[:1]
                )
            ).values(
                'TRC_PP_CODE','TRC_MCH_CODE','TRC_SO_CODE',
                'TRC_MAT_SAP_CODE','TRC_WM_CODE','TRC_START_TIME',
                'TRC_END_TIME','TRC_CU_EXT_PROGR','MAT_CODE'
            ).first()

            if detail:
                detail.update({
                    'level': level,
                    'type': 'child',
                    'OPERATOR_PROD': operator,
                    'PP_CODE': info['PP_CODE'],
                    'MCH_CODE': info['MCH_CODE'],
                    'PRODUCTION_DATE': info['PRODUCTION_DATE'],
                })
                child_data.append(detail)
                child_data += get_child_cu_tree(cu_ext, level + 1)

        return child_data

    traceability_tree = []
    for item in traceability_raw:
        info = get_pp_mch_wm_from_cu(item['TRC_CU_EXT_PROGR'])
        operator = {'WM_CODE': info['WM_CODE'], 'WM_NAME': get_worker_name(info['WM_CODE'])}

        root_node = {
            'type': 'root',
            'level': 0,
            **item,
            'OPERATOR_PROD': operator,
            'PP_CODE': info['PP_CODE'],
            'MCH_CODE': info['MCH_CODE'],
            'PRODUCTION_DATE': info['PRODUCTION_DATE'],
        }
        traceability_tree.append(root_node)
        traceability_tree += get_child_cu_tree(item['TRC_CU_EXT_PROGR'], 1)

    context = {
        'trc_list': trc_list,
        'machines': machines,
        'phase': phase,
        'date_shift_choices': date_shift_choices,
        'traceability_tree': traceability_tree,
        'selected_trc': trc_code,
        'selected_mch_info': mch_info,
        'selected_start_date': start_date_raw,
        'selected_end_date': end_date_raw,
        'selected_phase': trc_fl_phase,
    }
    return render(request, 'traceability_by_machine.html', context) -->



<!-- 
1. ada form production phase isinya TRC_PP_CODE(MODEL WMS_TRACEABILITY) dan PP_DESC (MD_PRODUCTION_PHASES) 
2. ada form machine tampil berdasarkan form production phase yang terpilih isinya TRC_PP_CODE (MODEL WMS_TRACEABILITY)  dan  TRC_MCH_CODE (MODEL WMS_TRACEABILITY) 
3. ada form fl phase isinya TRC_FL_PHASE 
4. ada form tanggal dari TRC_START_TIME dan TRC_END_TIME  (dari model WMS_TRACEABILITY) kalo di ketentuan tampilannya kalo shift 1 (00-08) shift 2 (08-16), shift 3 (16-00)
5. lalu muncul traceability views. berdasarkan ke empat form tersebut, berdasarkan TRC_PP_CODE,TRC_MSH_CODE, TRC_FL_PHASE, DAN TANGGAL TANGGALNYA
6. format traceabily views nya tiap level ada 2 baris yaitu baris pertama  {{ row.TRC_SO_CODE }} {{ row.TRC_CU_EXT_PROGR }}-{{ row.MAT_CODE }} - {{ row.TRC_MAT_SAP_CODE }} -({{ row.TRC_START_TIME }} - {{ row.TRC_END_TIME }}) - ({{ row.TRC_WM_CODE }} - {{ row.WM_NAME }}) ==> data berada di model WMS_TRACEABILITY, dan kalo yang WM_NAME ada di model (MD_WORKERS)
7. format baris 2 itu ngambil dari model WMS_TRACEABILITY_CU berdasarkan TRC_CU_EXT_PROGR yang ada di baris 1, di join dengan CU_EXT_PROGR di model WMS_TRACEABILITY_CU
8. sedangkan untuk childnya. diambil dari TRC_CU_EXT_PROGR join dengan WMS_TRACEABILITY_CU (yang apabila di wms_traceability_cu TRC_CU_EXT_PROGR ADALAH CU_EXT_PROGR ) LALU ada CHILD_CU_EXT_PROGR dan itu lah yang menjadi anak. lalu cari anaknya di induknya apabila masih memiliki anak tampil lagi sampai habis
-->
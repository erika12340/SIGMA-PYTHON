<!-- def traceability_by_machine(request):
    trc_code = request.GET.get('trc_code')
    mch_info = request.GET.get('mch_info')
    start_date_raw = request.GET.get('start_date')
    end_date_raw = request.GET.get('end_date')
    trc_fl_phase = request.GET.get('trc_fl_phase')

    def parse_date_shift(raw_value):
        try:
            date_part, shift_part = raw_value.split('|')
            return date_part, shift_part
        except:
            return None, None

    # Parse tanggal
    start_date, _ = parse_date_shift(start_date_raw)
    end_date, _ = parse_date_shift(end_date_raw)
    try:
        if start_date and end_date:
            start_date = datetime.strptime(start_date, "%Y-%m-%d").date()
            end_date = datetime.strptime(end_date, "%Y-%m-%d").date()
        else:
            start_date = end_date = None
    except ValueError:
        start_date = end_date = None

    # Ambil descriptor phase
    pp_desc_subquery = MD_PRODUCTION_PHASES.objects.filter(
        PP_CODE=OuterRef('TRC_PP_CODE')
    ).values('PP_DESC')[:1]

    trc_list = (
        WMS_TRACEABILITY.objects
        .annotate(PP_DESC=Subquery(pp_desc_subquery))
        .values('TRC_PP_CODE', 'PP_DESC')
        .distinct()
        .order_by('TRC_PP_CODE')
    )

    machines = []
    if trc_code:
        machines = (
            WMS_TRACEABILITY.objects
            .filter(TRC_PP_CODE=trc_code)
            .values('TRC_PP_CODE', 'TRC_MCH_CODE')
            .distinct()
            .order_by('TRC_MCH_CODE')
        )

    phase = (
        WMS_TRACEABILITY.objects
        .values('TRC_FL_PHASE')
        .distinct()
        .order_by('TRC_FL_PHASE')
    )

    date_shift_raw = (
        WMS_TRACEABILITY.objects
        .annotate(date=TruncDate('TRC_START_TIME'))
        .values('TRC_START_TIME', 'date')
        .annotate(shift=Subquery(
            DC_PRODUCTION_DATA.objects.filter(
                PS_START_PROD=OuterRef('TRC_START_TIME')
            ).values('SHF_CODE')[:1]
        ))
        .values('date', 'shift')
        .distinct()
        .order_by('-date')
    )
    date_shift_choices = [
        {'value': f"{d['date']}|{d['shift']}", 'label': f"{d['date'].strftime('%d/%m/%Y')} - {d['shift']}"}
        for d in date_shift_raw if d['shift']
    ]

    # Filter traceability utama
    traceability_raw = []
    if trc_code and mch_info and start_date and end_date and trc_fl_phase:
        traceability_qs = WMS_TRACEABILITY.objects.filter(
            TRC_START_TIME__date__range=(start_date, end_date)
        ).annotate(
            MAT_CODE=Subquery(
                MD_MATERIALS.objects.filter(
                    MAT_SAP_CODE=OuterRef('TRC_MAT_SAP_CODE')
                ).values('MAT_CODE')[:1]
            ),
            WM_CODE=Subquery(
                MD_WORKERS.objects.filter(
                    WM_CODE=OuterRef('TRC_WM_CODE')
                ).values('WM_CODE')[:1]
            ),
            WM_NAME=Subquery(
                MD_WORKERS.objects.filter(
                    WM_CODE=OuterRef('TRC_WM_CODE')
                ).values('WM_NAME')[:1]
            )
        )
        if trc_code:
            traceability_qs = traceability_qs.filter(TRC_PP_CODE=trc_code)
        if trc_fl_phase:
            traceability_qs = traceability_qs.filter(TRC_FL_PHASE=trc_fl_phase)
        if mch_info:
            try:
                trc_pp, trc_mch = mch_info.split('|')
                traceability_qs = traceability_qs.filter(
                    TRC_PP_CODE=trc_pp, TRC_MCH_CODE=trc_mch
                )
            except ValueError:
                pass

        traceability_raw = list(traceability_qs.values(
            'TRC_PP_CODE', 'TRC_MCH_CODE', 'TRC_SO_CODE', 'TRC_MAT_SAP_CODE',
            'TRC_WM_CODE', 'TRC_START_TIME', 'TRC_END_TIME', 'TRC_CU_EXT_PROGR',
            'MAT_CODE', 'WM_CODE', 'WM_NAME'
        ))

    # Fungsi bantu
    def get_pp_mch_wm_from_cu(cu_ext_progr):
        info = WMS_TRACEABILITY_CU.objects.filter(
            CU_EXT_PROGR=cu_ext_progr
        ).values('PP_CODE', 'MCH_CODE', 'PRODUCTION_DATE', 'WM_CODE').first()
        return info or {'PP_CODE': '', 'MCH_CODE': '', 'PRODUCTION_DATE': '', 'WM_CODE': ''}

    def get_worker_name(wm_code):
        if not wm_code:
            return ''
        worker = MD_WORKERS.objects.filter(WM_CODE=wm_code).values('WM_NAME').first()
        return worker['WM_NAME'] if worker else ''

    def get_child_cu_tree(parent_cu, level=1):
        child_data = []
        children = WMS_TRACEABILITY_CU.objects.filter(
            CHILD_CU_EXT_PROGR=parent_cu
        ).values('CHILD_CU_EXT_PROGR', 'PRODUCTION_DATE', 'PP_CODE', 'MCH_CODE', 'WM_CODE')

        for child in children:
            cu_ext = child['CHILD_CU_EXT_PROGR']
            info = get_pp_mch_wm_from_cu(cu_ext)
            operator = {'WM_CODE': info['WM_CODE'], 'WM_NAME': get_worker_name(info['WM_CODE'])}

            detail = WMS_TRACEABILITY.objects.filter(
                TRC_CU_EXT_PROGR=cu_ext
            ).annotate(
                MAT_CODE=Subquery(
                    MD_MATERIALS.objects.filter(
                        MAT_SAP_CODE=OuterRef('TRC_MAT_SAP_CODE')
                    ).values('MAT_CODE')[:1]
                )
            ).values(
                'TRC_PP_CODE','TRC_MCH_CODE','TRC_SO_CODE',
                'TRC_MAT_SAP_CODE','TRC_WM_CODE','TRC_START_TIME',
                'TRC_END_TIME','TRC_CU_EXT_PROGR','MAT_CODE'
            ).first()

            if detail:
                detail.update({
                    'level': level,
                    'type': 'child',
                    'OPERATOR_PROD': operator,
                    'PP_CODE': info['PP_CODE'],
                    'MCH_CODE': info['MCH_CODE'],
                    'PRODUCTION_DATE': info['PRODUCTION_DATE'],
                })
                child_data.append(detail)
                child_data += get_child_cu_tree(cu_ext, level + 1)

        return child_data

    traceability_tree = []
    for item in traceability_raw:
        info = get_pp_mch_wm_from_cu(item['TRC_CU_EXT_PROGR'])
        operator = {'WM_CODE': info['WM_CODE'], 'WM_NAME': get_worker_name(info['WM_CODE'])}

        root_node = {
            'type': 'root',
            'level': 0,
            **item,
            'OPERATOR_PROD': operator,
            'PP_CODE': info['PP_CODE'],
            'MCH_CODE': info['MCH_CODE'],
            'PRODUCTION_DATE': info['PRODUCTION_DATE'],
        }
        traceability_tree.append(root_node)
        traceability_tree += get_child_cu_tree(item['TRC_CU_EXT_PROGR'], 1)

    context = {
        'trc_list': trc_list,
        'machines': machines,
        'phase': phase,
        'date_shift_choices': date_shift_choices,
        'traceability_tree': traceability_tree,
        'selected_trc': trc_code,
        'selected_mch_info': mch_info,
        'selected_start_date': start_date_raw,
        'selected_end_date': end_date_raw,
        'selected_phase': trc_fl_phase,
    }
    return render(request, 'traceability_by_machine.html', context) -->


<!-- 
CATATAN ALUR BY MACHINE
1. ada form production phase isinya TRC_PP_CODE(MODEL WMS_TRACEABILITY) dan PP_DESC (MD_PRODUCTION_PHASES) 
2. ada form machine tampil berdasarkan form production phase yang terpilih isinya TRC_PP_CODE (MODEL WMS_TRACEABILITY)  dan  TRC_MCH_CODE (MODEL WMS_TRACEABILITY) 
3. ada form fl phase isinya TRC_FL_PHASE 
4. dan ada form tanggal TRC_START_TIME dan TRC_END_TIME di model WMS_TRACEABILITY dan tambahan shift dimana time pada kolom TRC_START_TIME dan TRC_END_TIME di kompress jadi shift 1,2,3 dengan ketentuan jam 00:00:00 - 08:00:00 (shift 1), 08:00:00 - 16:00:00 (shift 2), dan 16:00:00 - 24:00:00 atau 00.00.00 aku kurang tau penulisannya itu jadi (shift 3)
5. Ada logika tambahan pada fl_phase yaitu ketika di form fl_phase yang dipilih berstatus C maka di baris 1 tampil data yang TRC_FL_PHASE nya berstatus C dan baris 2 tampil yang TRC_FL_PHASE nya berstatus P. 
    Jika TRC_FL_PHASE yang dipilih berstatus P maka baris 1 tampil data TRC_FL_PHASE berstatus p dan baris 2 tampil TRC_FL_PHASE yang berstatus C. 

UNTUK FORMATNYA traceability views YAITU SEBAGAI BERIKUT:
6. ISI BARIS 1 {{ row.TRC_SO_CODE }} {{ row.TRC_CU_EXT_PROGR }}-{{ row.MAT_CODE }} - {{ row.TRC_MAT_SAP_CODE }} -({{ row.TRC_START_TIME }} - {{ row.TRC_END_TIME }}) - ({{ row.TRC_WM_CODE }} ==> data berada di model WMS_TRACEABILITY, dan - {{ row.WM_NAME }}) ==> kalo yang WM_NAME ada di model (MD_WORKERS)
7. ISI baris 2 {{ row.PP_CODE }} {{ row.MCH_CODE }} - ({{ row.TRC_START_TIME }} - {{ row.TRC_END_TIME }}) - ({{ row.TRC_WM_CODE }}  ==> data berada di model WMS_TRACEABILITY, DAN ADA DATA {{ row.WM_NAME }})  kalo yang WM_NAME ada di model (MD_WORKERS) 
8. untuk pengaturan child. yaitu berdasarkan TRC_SO_CODE dan TRC_CU_EXT_PROGR ( yang ada di model [WMS_TRACEABILITY]) dimana apabila di model [WMS_TRACEABILITY_CU] namanya [SO_CODE] dan [CU_EXT_PROGR] di cari childnya di model [WMS_TRACEABILITY_CU] dimana ada [CHILD_CU_CODE] dan [CHILD_CU_EXT_PROGR].  
Nah setelah ketemu childnya, baru cari lagi di WMS_TRACEABILITY sebagai TRC_SO_CODE dan TRC_CU_EXT_PROGR. dan tampilkan dengan tampilan dan ketentuan seperti di poin sebelumnya. 
9. begitu seterusnya sampai tidak ada child
-->



<!-- 
CATATAN ALUR MY CONTAINMENT UNIT (CU)
1. Ada form TRC_SO_CODE (ADA DI MODEL WMS_TRACEABILITY) DAN SO_DESC ADA DI (MODEL MD_SOURCES)
2. Ada form TRC_SO_CODE dan TRC_CU_EXT_PROGR di model  WMS_TRACEABILITY
3. ada form fl phase isinya TRC_FL_PHASE 
4. dan ada form tanggal TRC_START_TIME dan TRC_END_TIME di model WMS_TRACEABILITY dan tambahan shift dimana time pada kolom TRC_START_TIME dan TRC_END_TIME di kompress jadi shift 1,2,3 dengan ketentuan jam 00:00:00 - 08:00:00 (shift 1), 08:00:00 - 16:00:00 (shift 2), dan 16:00:00 - 24:00:00 atau 00.00.00 aku kurang tau penulisannya itu jadi (shift 3)
5. apabila form fl_phase yang dipilih C maka yang tampil di baris 1 TRC_FL_PHASE berstatus P dan baris 2 TRC_FL_PHASE nya berstatus C. begitu sebaliknya apabila yang dipilih adalah P maka yang tampil baris 1 adalah TRC_FL_PHASE berstatus C dan baris 2 TRC_FL_PHASE berstatus P
UNTUK FORMAT TRACEABILITY BY CU SEBAGAI BERIKUT:
6. ISI BARIS 1 {{ row.PP_CODE }} - {{ row.MCH_CODE }} - ({{ row.TRC_START_TIME }} - {{ row.TRC_END_TIME }}) - ({{ row.TRC_WM_CODE }} - {{ row.WM_NAME }})
7. ISI BARIS 2 {{ row.TRC_SO_CODE }} {{ row.TRC_CU_EXT_PROGR }} - {{ row.MAT_CODE }} - {{ row.TRC_MAT_SAP_CODE }} - ({{ row.TRC_START_TIME }} - {{ row.TRC_END_TIME }}) - ({{ row.TRC_WM_CODE }} - {{ row.WM_NAME }})
8. untuk pengaturan child. yaitu berdasarkan TRC_SO_CODE dan TRC_CU_EXT_PROGR ( yang ada di model [WMS_TRACEABILITY]) dimana apabila di model [WMS_TRACEABILITY_CU] namanya [SO_CODE] dan [CU_EXT_PROGR] di cari childnya di model [WMS_TRACEABILITY_CU] dimana ada [CHILD_CU_CODE] dan [CHILD_CU_EXT_PROGR].  
Nah setelah ketemu childnya, baru cari lagi di WMS_TRACEABILITY sebagai TRC_SO_CODE dan TRC_CU_EXT_PROGR. dan tampilkan dengan tampilan dan ketentuan seperti di poin sebelumnya. 
9. begitu seterusnya sampai tidak ada child

WHERE CONCAT (TRC_SO_CODE,TRC_CU_EXT_PROGR) = 'SM1100DL0R'
WHERE CONCAT( CHILD_SO_CODE,CHILD_CU_EXT_PROGR) = 'SM1100DL0R'
-->


<!-- 
CATATAN ALUR MY MATERIALS (CU)
1. Ada form {{ sfc.SFC_CODE }} - {{ sfc.SFC_DESC }} DARI MODEL MD_SEMI_FINISHED_CLASSES
2. Ada form {{ m.MAT_CODE }} - {{ m.MAT_SAP_CODE }} - {{ m.MAT_VARIANT }} - {{ m.CNT_CODE }} - {{ m.MAT_DESC }} DI MD_MATERIALS
3. ada form fl phase isinya TRC_FL_PHASE 
4. dan ada form tanggal TRC_START_TIME dan TRC_END_TIME di model WMS_TRACEABILITY dan tambahan shift dimana time pada kolom TRC_START_TIME dan TRC_END_TIME di kompress jadi shift 1,2,3 dengan ketentuan jam 00:00:00 - 08:00:00 (shift 1), 08:00:00 - 16:00:00 (shift 2), dan 16:00:00 - 24:00:00 atau 00.00.00 aku kurang tau penulisannya itu jadi (shift 3)
5. DATA TAMPIL BERDASARKAN WHERE [TRC_MAT_SAP_CODE] = 'STB6965A0' AND [TRC_CNT_CODE] = 'TF2' AND [TRC_MAT_VARIANT] = '#' AND TRC_FL_PHASE = 'C' 
AND CAST(TRC_START_TIME AS DATE) = '2025-09-05'
6. Dan untuk tambahan ketentuan tampil di htmlnya apabila form fl_phase yang dipilih C maka yang tampil di baris 1 TRC_FL_PHASE berstatus P dan baris 2 TRC_FL_PHASE nya berstatus C. begitu sebaliknya apabila yang dipilih adalah P maka yang tampil baris 1 adalah TRC_FL_PHASE berstatus C dan baris 2 TRC_FL_PHASE berstatus P
UNTUK FORMATNYA traceability views BY MATERIALS YAITU SEBAGAI BERIKUT:
7. ISI BARIS 1 {{ row.TRC_SO_CODE }} {{ row.TRC_CU_EXT_PROGR }}-{{ row.MAT_CODE }} - {{ row.TRC_MAT_SAP_CODE }} -({{ row.TRC_START_TIME }} - {{ row.TRC_END_TIME }}) - ({{ row.TRC_WM_CODE }} ==> data berada di model WMS_TRACEABILITY, dan - {{ row.WM_NAME }}) ==> kalo yang WM_NAME ada di model (MD_WORKERS)
8. ISI baris 2 {{ row.PP_CODE }} {{ row.MCH_CODE }} - ({{ row.TRC_START_TIME }} - {{ row.TRC_END_TIME }}) - ({{ row.TRC_WM_CODE }}  ==> data berada di model WMS_TRACEABILITY, DAN ADA DATA {{ row.WM_NAME }})  kalo yang WM_NAME ada di model (MD_WORKERS) 
9. untuk pengaturan child. yaitu berdasarkan TRC_SO_CODE dan TRC_CU_EXT_PROGR ( yang ada di model WMS_TRACEABILITY) dimana apabila di model [WMS_TRACEABILITY_CU] namanya [SO_CODE] dan [CU_EXT_PROGR] di cari childnya di model [WMS_TRACEABILITY_CU] dimana ada [CHILD_CU_CODE] dan [CHILD_CU_EXT_PROGR].  
Nah setelah ketemu childnya, baru cari lagi di WMS_TRACEABILITY sebagai TRC_SO_CODE dan TRC_CU_EXT_PROGR. dan tampilkan dengan tampilan dengan ketentuan seperti di poin sebelumnya. 
10. begitu seterusnya sampai tidak ada child
-->
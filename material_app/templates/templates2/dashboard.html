{% extends "templates2/index.html" %}
{% load static %}
{% block content %}

<div class="content-wrapper text-light">
  <div class="container-xxl flex-grow-1 container-p-y">

    <!-- ==================== Total Data ====================== -->
    <div class="row gy-6">
      <h4 class="mb-4 fw-semibold text-white">Dashboard</h4>

      <!-- Filter Tanggal Total Produksi -->
      <div class="col-12 mb-4">
        <div class="card border border-secondary rounded-3 shadow-sm p-3 bg-dark">
          <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
            <label for="production-date" class="form-label mb-0 text-white">Pilih Tanggal Produksi:</label>
            <input type="date" id="production-date"
                   class="form-control w-auto bg-dark text-white border-secondary"
                   onchange="filterByDate(this.value)"
                   value="{{ selected_date|default:'' }}" />
          </div>
        </div>
      </div>

      <!-- Statistik Produksi -->
      <div class="col-12">
        <div class="row g-4">
          <div class="col-md-4">
            <div class="card border border-primary rounded-3 shadow"
                 style="background-color: rgba(13, 110, 253, 0.25);">
              <div class="card-body text-center py-4">
                <h6 class="text-white mb-2">Total Consumed</h6>
                <h3 class="mb-0 fw-bold text-white">{{ total_consumed|default:"--" }}</h3>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card border border-success rounded-3 shadow"
                 style="background-color: rgba(25, 135, 84, 0.3);">
              <div class="card-body text-center py-4">
                <h6 class="text-white mb-2">Total Produced</h6>
                <h3 class="mb-0 fw-bold text-white">{{ total_produced|default:"--" }}</h3>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card border border-warning rounded-3 shadow"
                 style="background-color: rgba(255, 193, 7, 0.25);">
              <div class="card-body text-center py-4">
                <h6 class="text-white mb-2">Total Produksi</h6>
                <h3 class="mb-0 fw-bold text-white">{{ total_produksi|default:"--" }}</h3>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ==================== Filter & Tabel Produksi ====================== -->
    <div class="container mt-5">
      <h2 class="text-center mb-4 text-white">Durasi Mesin Produksi</h2>

      <!-- Filter -->
      <div class="card border border-secondary bg-dark p-3 mb-4">
        <form method="GET" class="row g-3 align-items-end">

          <!-- SFC CODE -->
          <div class="col-md-3">
            <label class="form-label text-white mb-1">SFC Code</label>
            <select name="sfc_code"
                    class="form-control bg-dark text-white border-secondary"
                    onchange="this.form.submit()">
              <option value="">-- Pilih SFC --</option>
              {% for sfc in daftar_sfc %}
                <option value="{{ sfc }}" {% if selected_sfc == sfc %}selected{% endif %}>{{ sfc }}</option>
              {% endfor %}
            </select>
          </div>

          <!-- MAT SAP CODE -->
          <div class="col-md-3">
            <label class="form-label text-white mb-1">MAT SAP Code</label>
            <select name="mat_sap_code"
                    class="form-control bg-dark text-white border-secondary"
                    onchange="this.form.submit()">
              <option value="">-- Pilih Material --</option>
              {% for mat in daftar_mat_sap %}
                <option value="{{ mat }}" {% if selected_mat_sap == mat %}selected{% endif %}>{{ mat }}</option>
              {% endfor %}
            </select>
          </div>

          <!-- PS_DATE -->
          <div class="col-md-3">
            <label class="form-label text-white mb-1">Tanggal Produksi (PS_DATE)</label>
            <select name="ps_date"
                    class="form-control bg-dark text-white border-secondary">
              <option value="">-- Pilih Tanggal --</option>
              {% for tgl in daftar_tanggal %}
                <option value="{{ tgl|date:'Y-m-d' }}" {% if selected_ps_date == tgl|date:'Y-m-d' %}selected{% endif %}>
                  {{ tgl|date:"Y-m-d" }}
                </option>
              {% endfor %}
            </select>
          </div>

          <div class="col-md-3">
            <button type="submit" class="btn btn-primary w-100">Filter</button>
        </form>
      </div>

      <!-- TABEL -->
      <div class="card border border-primary shadow bg-dark text-white mt-5">
        <div class="card-header bg-primary text-white ">
          <h5 class="mb-0">Data Durasi Produksi per Mesin</h5>
        </div>
        <div class="card-body table-responsive">
          <table class="table table-dark table-hover table-bordered align-middle mb-0">
            <thead class="table-primary text-dark">
              <tr>
                <th>#</th>
                <th>Ip Materials</th>
                <th>Kode Mesin</th>
                <th>SFC Desc</th>
                <th>Waktu Mulai</th>
                <th>Waktu Selesai</th>
                <th>Durasi (Jam)</th>
              </tr>
            </thead>
            <tbody>
              {% if tabel_data %}
                {% for row in tabel_data %}
                  <tr>
                    <td>{{ forloop.counter }}</td>
                    <td>{{ row.mat_sap_code }}</td>
                    <td>{{ row.mch_code }}</td>
                    <td>{{ row.sfc_desc }}</td>
                    <td>{{ row.ps_start_prod|date:"Y-m-d H:i" }}</td>
                    <td>{{ row.ps_end_prod|date:"Y-m-d H:i" }}</td>
                    <td>{{ row.durasi_jam|floatformat:2 }}</td>
                  </tr>
                {% endfor %}
              {% else %}
                <tr>
                  <td colspan="6" class="text-center text-muted">Tidak ada data untuk filter ini.</td>
                </tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Script Filter Total Produksi -->
  <script>
    function filterByDate(date) {
      const url = new URL(window.location.href);
      url.searchParams.set('date', date);
      window.location.href = url.toString();
    }
  </script>

</div>
{% endblock %}

{% extends "templates2/index.html" %}
{% block content %}

<!-- Select2 CSS & JS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<style>
    /* Indentasi berdasarkan level */
    .level-1 {
        margin-left: 1em;
    }

    .level-2 {
        margin-left: 2em;
    }

    .level-3 {
        margin-left: 3em;
    }

    .level-4 {
        margin-left: 4em;
    }

    .level-5 {
        margin-left: 5em;
    }

    /* Background warna untuk child rows */
    .child-row {
        padding: 5px;
        margin-left: 1em;
        border-left: 3px solid;
    }

    .root-row {
        font-weight: bold;
        padding: 5px;
        margin-top: 10px;
        border-bottom: 1px solid #ca2bff;
    }
</style>

<!-- Navbar -->
<nav>
    <div class="nav nav-tabs" id="nav-tab" role="tablist">
        <button class="nav-link active" id="nav-RBMachine-tab" data-bs-toggle="tab" data-bs-target="#nav-RBMachine"
            type="button" role="tab" aria-controls="nav-RBMachine" aria-selected="true">By RBMachine</button>
        <button class="nav-link" id="nav-CU-tab" data-bs-toggle="tab" data-bs-target="#nav-CU" type="button" role="tab"
            aria-controls="nav-CU" aria-selected="false">By CU
        </button>
        <button class="nav-link" id="nav-Material-tab" data-bs-toggle="tab" data-bs-target="#nav-Material" type="button"
            role="tab" aria-controls="nav-Material" aria-selected="false">By Material
        </button>
    </div>
</nav> <!-- /Navbar -->

<div class="container">
    <h3 style="margin-left: 30px;">Traceability Views</h3>

    <!-- Filter Form -->
    <form method="get" action="{% url 'traceability' %}" class="row g-3" id="filterForm">

        <div class="col-md-4">
            <label for="trc" class="form-label fw-bold">Production Phase :</label>
            <select name="trc_code" id="production" class="form-select" onchange="this.form.submit()">
                <option value="">-- Pilih Fase --</option>
                {% for trc in trc_list %}
                <option value="{{ trc.TRC_PP_CODE }}" {% if trc.TRC_PP_CODE == selected_trc %}selected{% endif %}>
                    {{ trc.TRC_PP_CODE }} - {{ trc.PP_DESC }}
                </option>
                {% endfor %}
            </select>
        </div>

        <div class="col-md-4">
            <label for="mch_info" class="form-label fw-bold">Machine :</label>
            <select name="mch_info" id="mch_info" class="form-select" onchange="this.form.submit()">
                <option value="">-- Pilih Mesin --</option>
                {% for m in machines %}
                {% with value=m.TRC_PP_CODE|add:"|"|add:m.TRC_MCH_CODE %}
                <option value="{{ value }}" {% if selected_mch_info == value %}selected{% endif %}>
                    {{ m.TRC_PP_CODE }} - {{ m.TRC_MCH_CODE }}
                </option>
                {% endwith %}
                {% endfor %}
            </select>
        </div>

        <div class="col-md-4">
            <label for="trc_fl_phase" class="form-label fw-bold">Traceability Phase :</label>
            <select name="trc_fl_phase" id="trc_fl_phase" class="form-select" onchange="this.form.submit()">
                <option value="">-- Pilih Traceability Phase --</option>
                {% for p in phase %}
                <option value="{{ p.TRC_FL_PHASE }}" {% if p.TRC_FL_PHASE == selected_phase %}selected{% endif %}>
                    {{ p.TRC_FL_PHASE }}
                </option>
                {% endfor %}
            </select>
        </div>

        <div class="col-md-4">
            <label for="start_date" class="form-label fw-bold">From :</label>
            <select name="start_date" id="start_date" class="form-select" onchange="this.form.submit()">
                <option value="">-- Pilih Tanggal & Shift --</option>
                {% for opt in date_shift_choices %}
                <option value="{{ opt.value }}" {% if selected_start_date == opt.value %}selected{% endif %}>
                    {{ opt.label }}
                </option>
                {% endfor %}
            </select>
        </div>

        <div class="col-md-4">
            <label for="end_date" class="form-label fw-bold">To :</label>
            <select name="end_date" id="end_date" class="form-select" onchange="this.form.submit()">
                <option value="">-- Pilih Tanggal & Shift --</option>
                {% for opt in date_shift_choices %}
                <option value="{{ opt.value }}" {% if selected_end_date == opt.value %}selected{% endif %}>
                    {{ opt.label }}
                </option>
                {% endfor %}
            </select>
        </div>

    </form>

    <!-- Traceability List -->
    <div id="material-tree" class="mt-4">
        {% if traceability_tree %}
        {% for row in traceability_tree %}
        {% if row.type == 'root' %}

        <!-- BARIS 1 -->
        <div class="root-row level-{{ row.level }}" id="root-{{ forloop.counter }}">
            <button class="toggle-btn" data-id="{{ forloop.counter }}">▶</button>
            {{ row.key }} <br>

            {{ row.MAT_CODE|default:"-" }} -
            {{ row.TRC_MAT_SAP_CODE|default:"-" }} -
            ({{ row.TRC_START_TIME|date:"Y-m-d H:i"|default:"-" }}) -
            {{ row.TRC_END_TIME|date:"Y-m-d H:i"|default:"-" }} <br>
            {{ row.TRC_WM_CODE|default:"-" }}
        </div>

        <!-- BARIS 2 -->
        <div class="child-container" id="child-container-{{ forloop.counter }}" style="display:none; margin-left: 1em;">
            {% for child in traceability_tree %}
            {% if child.type == 'child' and child.parent_key == row.key %}
            <div class="child-row level-{{ child.level }}">
                {{ child.TRC_PP_CODE }} |
                {{ child.TRC_MCH_CODE }} <br>
                {{ child.TRC_START_TIME|date:"Y-m-d H:i"|default:"-" }} -
                {{ child.TRC_END_TIME|date:"Y-m-d H:i"|default:"-" }} <br>
                {{ child.TRC_WM_CODE|default:"-" }} - {{ child.WM_CODE|default:"-" }}
            </div>
            {% endif %}
            {% endfor %}
        </div>
        {% endif %}
        {% endfor %}
        {% else %}
        <p>No data available for selected filters.</p>
        {% endif %}
    </div>
</div>












<!-- TAB: By CU -->
<div class="tab-pane fade" id="nav-CU" role="tabpanel" aria-labelledby="nav-profile-CU">
    <div class="container mt-4">
        <h2 class="mb-4">By CU</h2>

        {% if error_message %}
        <div class="alert alert-warning alert-dismissible fade show" role="alert">
            {{ error_message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endif %}

        <div class="card mb-4 shadow-sm">
            <div class="card-body">
                <form method="get" action="{% url 'traceability' %}" class="row g-3" id="filterForm">
                    <div class="col-md-4">
                        <label for="sfc" class="form-label fw-bold">Source:</label>
                        <select name="sfc_code" id="sfc" class="form-select" onchange="this.form.submit()">
                            <option value="">-- Pilih Source --</option>
                            {% for sfc in sfc_list %}
                            <option value="{{ sfc.SFC_CODE }}" {% if sfc.SFC_CODE == selected_sfc %}selected{% endif %}>
                                {{ sfc.SFC_CODE }} - {{ sfc.SFC_DESC }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="col-md-4">
                        <label for="mat" class="form-label fw-bold">Containment Unit :</label>
                        <select name="mat_info" id="mat" class="form-select" onchange="this.form.submit()">
                            <option value="">-- Pilih Containment --</option>
                            {% for m in materials %}
                            <option value="{{ m.MAT_CODE }}|{{ m.MAT_SAP_CODE }}|{{ m.MAT_VARIANT }}|{{ m.CNT_CODE }}"
                                {% if selected_mat_info == m.MAT_CODE|stringformat:"s"|add:"|"|add:m.MAT_SAP_CODE|add:"|"|add:m.MAT_VARIANT|add:"|"|add:m.CNT_CODE %}selected{% endif %}>
                                {{ m.MAT_CODE }} - {{ m.MAT_SAP_CODE }} - {{ m.CNT_CODE }} - {{ m.MAT_VARIANT }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="col-md-2">
                        <label for="start_date" class="form-label fw-bold">From :</label>
                        <input type="date" name="start_date" id="start_date" class="form-control"
                            value="{{ selected_start_date|default:'' }}">
                    </div>

                    <div class="col-md-2">
                        <label for="end_date" class="form-label fw-bold">To :</label>
                        <input type="date" name="end_date" id="end_date" class="form-control"
                            value="{{ selected_end_date|default:'' }}">
                    </div>
                </form>

                <div class="col-12 mt-3">
                    <a href="{% url 'data_produksi' %}" class="btn btn-secondary">Reset</a>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-body">
                <form>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">CU</label>
                            <input type="text" class="form-control" value="{{ material_detail.mat_desc }}" readonly>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Material</label>
                            <input type="text" class="form-control" value="{{ material_detail.ip_code }}" readonly>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        {% for row in traceability_tree %}
        {% if row.type == 'root' %}
        <div class="root-node" style="font-weight: bold; margin-top: 10px;">
            {{ row.key }}
        </div>
        {% elif row.type == 'child' %}
        <div class="material-item level-2 mb-1">
            <button class="toggle-btn" data-id="{{ forloop.counter }}">▶</button>
            <strong>{{ row.TRC_SO_CODE }}</strong> - {{ row.TRC_PP_CODE }} - {{ row.TRC_MCH_CODE }} -
            {{ row.TRC_MAT_SAP_CODE }}
            <small class="text-muted">({{ row.TRC_START_TIME|date:"Y-m-d H:i" }})</small> -
            <small class="text-muted">({{ row.TRC_WM_CODE }})</small>
        </div>
        {% endif %}
        {% endfor %}
    </div>
</div>













<!-- TAB: By Material -->
<div class="tab-pane fade" id="nav-Material" role="tabpanel" aria-labelledby="nav-Material-tab">
    <div class="container mt-4">
        <h2 class="mb-4">By Materials</h2>

        <div class="card mb-4 shadow-sm">
            <div class="card-body">
                <form method="get" action="{% url 'data_produksi' %}" class="row g-3" id="filterForm">
                    <div class="col-md-4">
                        <label for="sfc" class="form-label fw-bold">Semifinished Class :</label>
                        <select name="sfc_code" id="sfc" class="form-select" onchange="this.form.submit()">
                            <option value="">-- Pilih SF --</option>
                            {% for sfc in sfc_list %}
                            <option value="{{ sfc.SFC_CODE }}" {% if sfc.SFC_CODE == selected_sfc %}selected{% endif %}>
                                {{ sfc.SFC_CODE }} - {{ sfc.SFC_DESC }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="col-md-4">
                        <label for="mat" class="form-label fw-bold">Materiale :</label>
                        <select name="mat_info" id="mat" class="form-select" onchange="this.form.submit()">
                            <option value="">-- Pilih Materiale --</option>
                            {% for m in materials %}
                            <option value="{{ m.MAT_CODE }}|{{ m.MAT_SAP_CODE }}|{{ m.MAT_VARIANT }}|{{ m.CNT_CODE }}"
                                {% if selected_mat_info == m.MAT_CODE|stringformat:"s"|add:"|"|add:m.MAT_SAP_CODE|add:"|"|add:m.MAT_VARIANT|add:"|"|add:m.CNT_CODE %}selected{% endif %}>
                                {{ m.MAT_CODE }} - {{ m.MAT_SAP_CODE }} - {{ m.CNT_CODE }} - {{ m.MAT_VARIANT }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="col-md-2">
                        <label for="start_date" class="form-label fw-bold">From :</label>
                        <input type="date" name="start_date" id="start_date" class="form-control"
                            value="{{ selected_start_date|default:'' }}">
                    </div>

                    <div class="col-md-2">
                        <label for="end_date" class="form-label fw-bold">To :</label>
                        <input type="date" name="end_date" id="end_date" class="form-control"
                            value="{{ selected_end_date|default:'' }}">
                    </div>
                </form>

                <div class="col-12 mt-3">
                    <a href="{% url 'data_produksi' %}" class="btn btn-secondary">Reset</a>
                </div>
            </div>
        </div>

        {% if error_message %}
        <div class="alert alert-warning alert-dismissible fade show" role="alert">
            {{ error_message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endif %}

        {% if material_data %}
        <div class="card">
            <div class="card-body">
                <h5 class="card-title mb-3">Daftar Material</h5>
                <div id="material-tree">
                    {% for row in material_data %}
                    <div class="material-item level-{{ row.level|add:1 }} mb-1">
                        <button class="toggle-btn" data-id="{{ forloop.counter }}">▶</button>
                        <strong>{{ row.MT_CODE }}</strong> - {{ row.SFC_CODE }} ({{ row.SFC_DESC }}) -
                        {{ row.MAT_CODE }} -
                        {{ row.CHILD_MAT_SAP_CODE }} - {{ row.CHILD_CNT_CODE }} - {{ row.MAT_VARIANT }} -
                        {{ row.MAT_DESC }} -
                        {{ row.BOM_QUANTITY }} {{ row.MAT_MEASURE_UNIT }} -
                        <small class="text-muted">({{ row.BV_STATUS }})</small>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>
</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q" crossorigin="anonymous">
</script>

<!-- JS UNTUK LINE DATA MATERIAL -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const toggleButtons = document.querySelectorAll('.toggle-btn');
        toggleButtons.forEach(btn => {
            btn.addEventListener('click', function () {
                const current = this.closest('.material-item');
                let next = current.nextElementSibling;
                while (next && parseInt(next.className.match(/level-(\d+)/)[1]) > parseInt(
                        current.className.match(/level-(\d+)/)[1])) {
                    next.style.display = next.style.display === 'none' ? 'block' : 'none';
                    next = next.nextElementSibling;
                }
                this.textContent = this.textContent === '▶' ? '▼' : '▶';
            });
        });

        // Tampilkan level 1 saat load
        const firstLevels = document.querySelectorAll('.level-1');
        firstLevels.forEach(el => el.style.display = 'block');
    });
</script>



<!-- JS UNTUK FORM -->
<script>
    $('#production').select2();
    $('#mch_info').select2();
    $('#trc_fl_phase').select2();
    $('#start_date').select2();
    $('#end_date').select2();
</script>

{% endblock %}






















{% extends "templates2/index.html" %}
{% block content %}

<style>
    /* Semua material-item disembunyikan dulu */
    .material-item {
        display: none;
    }

    /* Indentasi berdasarkan level */
    .level-1 {
        margin-left: 1em;
    }

    .level-2 {
        margin-left: 2em;
    }

    .level-3 {
        margin-left: 3em;
    }

    .level-4 {
        margin-left: 4em;
    }

    .level-5 {
        margin-left: 5em;
    }

    .level-6 {
        margin-left: 6em;
    }

    .level-7 {
        margin-left: 7em;
    }

    .level-8 {
        margin-left: 8em;
    }

    .level-9 {
        margin-left: 9em;
    }

    .level-10 {
        margin-left: 10em;
    }
</style>

<div class="container">
    <h3 style="margin-left: 30px ;">Traceability Views</h3>

    <!-- Navbar -->
    <nav>
        <div class="nav nav-tabs" id="nav-tab" role="tablist">

            <button class="nav-link active" id="nav-RBMachine-tab" data-bs-toggle="tab" data-bs-target="#nav-RBMachine"
                type="button" role="tab" aria-controls="nav-RBMachine" aria-selected="true">By RBMachine</button>

            <button class="nav-link" id="nav-CU-tab" data-bs-toggle="tab" data-bs-target="#nav-CU" type="button"
                role="tab" aria-controls="nav-CU" aria-selected="false">By CU</button>

            <button class="nav-link" id="nav-Material-tab" data-bs-toggle="tab" data-bs-target="#nav-Material"
                type="button" role="tab" aria-controls="nav-Material" aria-selected="false">By Material</button>

        </div>
    </nav>
    <!-- /Navbar -->

    <!-- Tab Content -->
    <div class="tab-content" id="nav-tabContent">



        <!-- TAB: By RBMachine -->
        <div class="tab-pane fade show active" id="nav-RBMachine" role="tabpanel" aria-labelledby="nav-RBMachine-tab">
            <div class="container mt-4">
                <h3 class="mb-4">By RBMachine</h3>

                <div class="card mb-4 shadow-sm">
                    <div class="card-body">

                        <!-- Form Produksi  -->
                        <form method="get" action="{% url 'traceability' %}" class="row g-3" id="filterForm">
                            <div class="col-md-4">
                                <label for="trc" class="form-label fw-bold">Production Phase :</label>
                                <select name="trc_code" id="trc" class="form-select" onchange="this.form.submit()">
                                    <option value="">-- Pilih Fase --</option>
                                    {% for trc in trc_list %}
                                    <option value="{{ trc.TRC_PP_CODE }}"
                                        {% if trc.TRC_PP_CODE == selected_trc %}selected{% endif %}>
                                        {{ trc.TRC_PP_CODE }} - {{ trc.PP_DESC }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>

                            <!-- Form Mesin -->
                            <div class="col-md-4">
                                <label for="mch_info" class="form-label fw-bold">Machine :</label>
                                <select name="mch_info" id="mch_info" class="form-select" onchange="this.form.submit()">
                                    <option value="">-- Pilih Mesin --</option>
                                    {% for m in machines %}
                                    {% with value=m.TRC_PP_CODE|add:"|"|add:m.TRC_MCH_CODE %}
                                    <option value="{{ value }}" {% if selected_mch_info == value %}selected{% endif %}>
                                        {{ m.TRC_PP_CODE }} - {{ m.TRC_MCH_CODE }}
                                    </option>
                                    {% endwith %}
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="col-md-4">
                                <label for="mch_info" class="form-label fw-bold">Traceability Phase :</label>
                                <select name="mch_info" id="mch_info" class="form-select" onchange="this.form.submit()">
                                    <option value="">-- Pilih Traceability Phase --</option>
                                    {% for p in phase %}
                                    <option value="{{ p.TRC_FL_PHASE }}"
                                        {% if p.TRC_FL_PHASE == selected_phase %}selected{% endif %}>
                                        {{ p.TRC_FL_PHASE }}
                                    </option>
                                    {% endfor %}

                                </select>
                            </div>

                            <!-- Tanggal dan Shift -->
                            <div class="col-md-4">
                                <label for="start_date" class="form-label fw-bold">From :</label>
                                <select name="start_date" id="start_date" class="form-select"
                                    onchange="this.form.submit()">
                                    <option value="">-- Pilih Tanggal & Shift --</option>
                                    {% for opt in date_shift_choices %}
                                    <option value="{{ opt.value }}"
                                        {% if selected_start_date == opt.value %}selected{% endif %}>
                                        {{ opt.label }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="col-md-4">
                                <label for="end_date" class="form-label fw-bold">To :</label>
                                <select name="end_date" id="end_date" class="form-select" onchange="this.form.submit()">
                                    <option value="">-- Pilih Tanggal & Shift --</option>
                                    {% for opt in date_shift_choices %}
                                    <option value="{{ opt.value }}"
                                        {% if selected_end_date == opt.value %}selected{% endif %}>
                                        {{ opt.label }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- DEBUG: Print JSON tree -->
                <pre>{{ traceability_tree|safe|json_script:"traceData" }}</pre>

                <!-- Daftar Traceability Berdasarkan Mesin-->
                {% if traceability_tree %}
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title mb-3">Traceability Views By Machine</h5>
                        <div id="material-tree">
                            {% for row in traceability_tree %}

                            <div class="material-item level-{{ row.level|add:1 }} mb-1">
                                <button class="toggle-btn" data-id="{{ forloop.counter }}">▶</button>
                                <strong>{{ row.TRC_SO_CODE }}</strong> - {{ row.TRC_MAT_SAP_CODE }}
                                <small class="text-muted">({{ row.TRC_START_TIME|date:"Y-m-d H:i" }})</small> -
                                <small class="text-muted">({{ row.TRC_WM_CODE }})</small>

                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>















        <!-- TAB: By CU -->
        <div class="tab-pane fade" id="nav-CU" role="tabpanel" aria-labelledby="nav-profile-CU">
            <div class="container mt-4">
                <h2 class="mb-4">By CU</h2>

                {% if error_message %}
                <div class="alert alert-warning alert-dismissible fade show" role="alert">
                    {{ error_message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                {% endif %}

                <div class="card mb-4 shadow-sm">
                    <div class="card-body">
                        <form method="get" action="{% url 'traceability' %}" class="row g-3" id="filterForm">
                            <div class="col-md-4">
                                <label for="sfc" class="form-label fw-bold">Source:</label>
                                <select name="sfc_code" id="sfc" class="form-select" onchange="this.form.submit()">
                                    <option value="">-- Pilih Source --</option>
                                    {% for sfc in sfc_list %}
                                    <option value="{{ sfc.SFC_CODE }}"
                                        {% if sfc.SFC_CODE == selected_sfc %}selected{% endif %}>
                                        {{ sfc.SFC_CODE }} - {{ sfc.SFC_DESC }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="col-md-4">
                                <label for="mat" class="form-label fw-bold">Containment Unit :</label>
                                <select name="mat_info" id="mat" class="form-select" onchange="this.form.submit()">
                                    <option value="">-- Pilih Containment --</option>
                                    {% for m in materials %}
                                    <option
                                        value="{{ m.MAT_CODE }}|{{ m.MAT_SAP_CODE }}|{{ m.MAT_VARIANT }}|{{ m.CNT_CODE }}"
                                        {% if selected_mat_info == m.MAT_CODE|stringformat:"s"|add:"|"|add:m.MAT_SAP_CODE|add:"|"|add:m.MAT_VARIANT|add:"|"|add:m.CNT_CODE %}selected{% endif %}>
                                        {{ m.MAT_CODE }} - {{ m.MAT_SAP_CODE }} - {{ m.CNT_CODE }} - {{ m.MAT_VARIANT }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="col-md-2">
                                <label for="start_date" class="form-label fw-bold">From :</label>
                                <input type="date" name="start_date" id="start_date" class="form-control"
                                    value="{{ selected_start_date|default:'' }}">
                            </div>

                            <div class="col-md-2">
                                <label for="end_date" class="form-label fw-bold">To :</label>
                                <input type="date" name="end_date" id="end_date" class="form-control"
                                    value="{{ selected_end_date|default:'' }}">
                            </div>
                        </form>

                        <div class="col-12 mt-3">
                            <a href="{% url 'data_produksi' %}" class="btn btn-secondary">Reset</a>
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-body">
                        <form>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">CU</label>
                                    <input type="text" class="form-control" value="{{ material_detail.mat_desc }}"
                                        readonly>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Material</label>
                                    <input type="text" class="form-control" value="{{ material_detail.ip_code }}"
                                        readonly>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                {% for row in traceability_tree %}
                {% if row.type == 'root' %}
                <div class="root-node" style="font-weight: bold; margin-top: 10px;">
                    {{ row.key }}
                </div>
                {% elif row.type == 'child' %}
                <div class="material-item level-2 mb-1">
                    <button class="toggle-btn" data-id="{{ forloop.counter }}">▶</button>
                    <strong>{{ row.TRC_SO_CODE }}</strong> - {{ row.TRC_PP_CODE }} - {{ row.TRC_MCH_CODE }} -
                    {{ row.TRC_MAT_SAP_CODE }}
                    <small class="text-muted">({{ row.TRC_START_TIME|date:"Y-m-d H:i" }})</small> -
                    <small class="text-muted">({{ row.TRC_WM_CODE }})</small>
                </div>
                {% endif %}
                {% endfor %}

            </div>
        </div>













        <!-- TAB: By Material -->
        <div class="tab-pane fade" id="nav-Material" role="tabpanel" aria-labelledby="nav-Material-tab">
            <div class="container mt-4">
                <h2 class="mb-4">By Materials</h2>

                <div class="card mb-4 shadow-sm">
                    <div class="card-body">
                        <form method="get" action="{% url 'data_produksi' %}" class="row g-3" id="filterForm">
                            <div class="col-md-4">
                                <label for="sfc" class="form-label fw-bold">Semifinished Class :</label>
                                <select name="sfc_code" id="sfc" class="form-select" onchange="this.form.submit()">
                                    <option value="">-- Pilih SF --</option>
                                    {% for sfc in sfc_list %}
                                    <option value="{{ sfc.SFC_CODE }}"
                                        {% if sfc.SFC_CODE == selected_sfc %}selected{% endif %}>
                                        {{ sfc.SFC_CODE }} - {{ sfc.SFC_DESC }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="col-md-4">
                                <label for="mat" class="form-label fw-bold">Materiale :</label>
                                <select name="mat_info" id="mat" class="form-select" onchange="this.form.submit()">
                                    <option value="">-- Pilih Materiale --</option>
                                    {% for m in materials %}
                                    <option
                                        value="{{ m.MAT_CODE }}|{{ m.MAT_SAP_CODE }}|{{ m.MAT_VARIANT }}|{{ m.CNT_CODE }}"
                                        {% if selected_mat_info == m.MAT_CODE|stringformat:"s"|add:"|"|add:m.MAT_SAP_CODE|add:"|"|add:m.MAT_VARIANT|add:"|"|add:m.CNT_CODE %}selected{% endif %}>
                                        {{ m.MAT_CODE }} - {{ m.MAT_SAP_CODE }} - {{ m.CNT_CODE }} - {{ m.MAT_VARIANT }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="col-md-2">
                                <label for="start_date" class="form-label fw-bold">From :</label>
                                <input type="date" name="start_date" id="start_date" class="form-control"
                                    value="{{ selected_start_date|default:'' }}">
                            </div>

                            <div class="col-md-2">
                                <label for="end_date" class="form-label fw-bold">To :</label>
                                <input type="date" name="end_date" id="end_date" class="form-control"
                                    value="{{ selected_end_date|default:'' }}">
                            </div>
                        </form>

                        <div class="col-12 mt-3">
                            <a href="{% url 'data_produksi' %}" class="btn btn-secondary">Reset</a>
                        </div>
                    </div>
                </div>

                {% if error_message %}
                <div class="alert alert-warning alert-dismissible fade show" role="alert">
                    {{ error_message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                {% endif %}

                {% if material_data %}
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title mb-3">Daftar Material</h5>
                        <div id="material-tree">
                            {% for row in material_data %}
                            <div class="material-item level-{{ row.level|add:1 }} mb-1">
                                <button class="toggle-btn" data-id="{{ forloop.counter }}">▶</button>
                                <strong>{{ row.MT_CODE }}</strong> - {{ row.SFC_CODE }} ({{ row.SFC_DESC }}) -
                                {{ row.MAT_CODE }} -
                                {{ row.CHILD_MAT_SAP_CODE }} - {{ row.CHILD_CNT_CODE }} - {{ row.MAT_VARIANT }} -
                                {{ row.MAT_DESC }} -
                                {{ row.BOM_QUANTITY }} {{ row.MAT_MEASURE_UNIT }} -
                                <small class="text-muted">({{ row.BV_STATUS }})</small>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q" crossorigin="anonymous">
</script>

<!-- JS UNTUK LINE DATA MATERIAL -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const toggleButtons = document.querySelectorAll('.toggle-btn');
        toggleButtons.forEach(btn => {
            btn.addEventListener('click', function () {
                const current = this.closest('.material-item');
                let next = current.nextElementSibling;
                while (next && parseInt(next.className.match(/level-(\d+)/)[1]) > parseInt(
                        current.className.match(/level-(\d+)/)[1])) {
                    next.style.display = next.style.display === 'none' ? 'block' : 'none';
                    next = next.nextElementSibling;
                }
                this.textContent = this.textContent === '▶' ? '▼' : '▶';
            });
        });

        // Tampilkan level 1 saat load
        const firstLevels = document.querySelectorAll('.level-1');
        firstLevels.forEach(el => el.style.display = 'block');
    });
</script>



<!-- JS UNTUK FORM -->
<script>
    $('#sfc').select2();
    $('#mat').select2();
</script>

{% endblock %}
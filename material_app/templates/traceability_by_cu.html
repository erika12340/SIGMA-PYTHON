{% extends "templates2/index.html" %}
{% block content %}

<style>
    /* Sembunyikan semua containment-item awalnya */
    .containment-item {
        display: none;
    }

    /* Indentasi berdasarkan level */
    .level-1 {
        margin-left: 1em;
    }

    .level-2 {
        margin-left: 2em;
    }

    .level-3 {
        margin-left: 3em;
    }

    .level-4 {
        margin-left: 4em;
    }

    .level-5 {
        margin-left: 5em;
    }

    .level-6 {
        margin-left: 6em;
    }

    .level-7 {
        margin-left: 7em;
    }

    .level-8 {
        margin-left: 8em;
    }

    .level-9 {
        margin-left: 9em;
    }

    .level-10 {
        margin-left: 10em;
    }
</style>

<div class="container">
    <h4 style="margin-left: 30px;">By Containment Unit (CU)</h4>
    <div class="container mt-4">
        <!-- Filter Form -->
        <div class="card mb-4 shadow-sm">
            <div class="card-body">
                <form method="get" action="traceability_by_cu" class="row g-3" id="filterForm">

                    <!-- Filter Source -->
                    <div class="col-md-4">
                        <label for="source" class="form-label fw-bold">Source :</label>
                        <select name="source_code" id="source" class="form-select" onchange="this.form.submit()">
                            <option value="">-- Pilih Source --</option>
                            {% for source in sources %}
                            <option value="{{ source.TRC_SO_CODE }}"
                                {% if selected_so_code == source.TRC_SO_CODE %}selected{% endif %}>
                                {{ source.TRC_SO_CODE }} - {{ source.SO_DESC }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Filter Containment Unit -->
                    <div class="col-md-4">
                        <label for="mat" class="form-label fw-bold">Containment Unit :</label>
                        <select name="mat_info" id="cu" class="form-select" onchange="this.form.submit()">
                            <option value="">-- Pilih Containment --</option>
                            {% for cu in cu_list %}
                            <option value="{{ cu.TRC_SO_CODE }}|{{ cu.TRC_CU_EXT_PROGR }}"
                                {% if mat_info == cu.TRC_SO_CODE|stringformat:"s"|add:"|"|add:cu.TRC_CU_EXT_PROGR|stringformat:"s" %}selected{% endif %}>
                                {{ cu.TRC_SO_CODE }}{{ cu.TRC_CU_EXT_PROGR }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Filter Traceability Phase -->
                    <div class="col-md-4">
                        <label for="trc_fl_phase" class="form-label fw-bold">Traceability Phase :</label>
                        <select name="trc_fl_phase" id="trc_fl_phase" class="form-select" onchange="this.form.submit()">
                            <option value="">-- Pilih Traceability Phase --</option>
                            {% for p in phase %}
                            <option value="{{ p.TRC_FL_PHASE }}"
                                {% if p.TRC_FL_PHASE == selected_phase %}selected{% endif %}>
                                {% if p.TRC_FL_PHASE == "C" %}C (Consumed)
                                {% elif p.TRC_FL_PHASE == "P" %}P (Production)
                                {% else %}{{ p.TRC_FL_PHASE }}{% endif %}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Filter Start Date -->
                    <div class="col-md-4">
                        <label for="start_date" class="form-label fw-bold">From :</label>
                        <select name="start_date" id="start_date" class="form-select" onchange="this.form.submit()">
                            <option value="">-- Pilih Tanggal & Shift --</option>
                            {% for opt in date_shift_choices %}
                            <option value="{{ opt.value }}"
                                {% if selected_start_date == opt.value %}selected{% endif %}>
                                {{ opt.label }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Filter End Date -->
                    <div class="col-md-4">
                        <label for="end_date" class="form-label fw-bold">To :</label>
                        <select name="end_date" id="end_date" class="form-select" onchange="this.form.submit()">
                            <option value="">-- Pilih Tanggal & Shift --</option>
                            {% for opt in date_shift_choices %}
                            <option value="{{ opt.value }}" {% if selected_end_date == opt.value %}selected{% endif %}>
                                {{ opt.label }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                </form>

                <div class="col-md-12 text-end mt-2">
                    <a href="traceability_by_cu" class="btn btn-secondary">Reset</a>
                </div>
            </div>
        </div>

        <!-- Menampilkan data containment unit (CU) dan Materils -->
        <div class="card mb-4">
            <div class="card-body">
                <form>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Containment Unit (CU)</label>
                            <input type="text" class="form-control" readonly
                                value="{% if data_cu %} {{ data_cu.TRC_SO_CODE }} {{ data_cu.TRC_CU_EXT_PROGR }}{% endif %}">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Materials</label>
                            <input type="text" class="form-control" readonly value="{% if materials %}
                                {{ materials.MAT_CODE }} - 
                                {{ materials.TRC_MAT_SAP_CODE }} - 
                                {{ materials.TRC_MAT_VARIANT }} - 
                                {{ materials.TRC_CNT_CODE }} - 
                                {{ materials.MAT_DESC }}
                                {% endif %}">
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Traceability Tree Display -->
        {% if traceability_by_cu %}
        <div class="card">
            <div class="card-body">
                <h5 class="card-title mb-3">Traceability Views By Containment Unit (CU)</h5>
                <div id="containment_raw_cu">
                    {% for row in traceability_by_cu %}
                    <div class="material-item level-{{ row.level|add:1 }} mb-1">
                        <div data-bs-spy="scroll" data-bs-target="#list-example" data-bs-offset="0"
                            class="scrollspy-example" tabindex="0">

                            <button class="toggle-btn" data-id="{{ forloop.counter }}">▶</button>
                            <!-- Baris 1 -->
                            {{ row.TRC_PP_CODE }} {{ row.TRC_MCH_CODE }} -
                            ({{ row.TRC_START_TIME }} - {{ row.TRC_END_TIME }}) -
                            ({{ row.TRC_WM_CODE }} - {{ row.WM_NAME }})

                            <!-- Baris 2 -->
                            <div style="margin-left: 8px; background-color: rgb(249, 222, 255);"></div>
                            {{ row.TRC_SO_CODE }} {{ row.TRC_CU_EXT_PROGR }} -
                            {{ row.MAT_CODE }} -
                            {{ row.TRC_MAT_SAP_CODE }} -
                            ({{ row.TRC_START_TIME }} - {{ row.TRC_END_TIME }}) -
                            ({{ row.TRC_WM_CODE }} - {{ row.WM_NAME }})

                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- JS BOOTSTRAP 5-->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q" crossorigin="anonymous">
</script>

<!-- JS UNTUK LINE MATERIAL -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const toggleButtons = document.querySelectorAll('.toggle-btn');
        toggleButtons.forEach(btn => {
            btn.addEventListener('click', function () {
                const current = this.closest('.material-item');
                let next = current.nextElementSibling;
                while (next && parseInt(next.className.match(/level-(\d+)/)[1]) > parseInt(
                        current.className.match(/level-(\d+)/)[1])) {
                    next.style.display = next.style.display === 'none' ? 'block' : 'none';
                    next = next.nextElementSibling;
                }
                this.textContent = this.textContent === '▶' ? '▼' : '▶';
            });
        });
        // Menambahkan 1 level 
        const firstLevels = document.querySelectorAll('.level-1');
        firstLevels.forEach(el => el.style.display = 'block');
    });
</script>

<!-- JS UNTUK FORM -->
<script>
    $('#source').select2();
    $('#cu').select2();
    $('#trc_fl_phase').select2();
    $('#start_date').select2();
    $('#end_date').select2();
</script>

{% endblock %}